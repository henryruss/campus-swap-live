{% extends "layout.html" %}

{% block body_class %}onboard-wizard{% endblock %}

{% block content %}
<script>if('scrollRestoration'in history)history.scrollRestoration='manual';window.scrollTo(0,0);</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
<style>
    .onboard-wizard .wizard-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 24px 80px;
    }
    .wizard-header {
        text-align: center;
        margin-bottom: 40px;
    }
    .wizard-header h1 {
        font-size: 1.75rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        margin-bottom: 8px;
    }
    .wizard-header .sub {
        color: var(--text-muted);
        font-size: 1rem;
    }
    .progress-bar-wrap {
        height: 8px;
        background: rgba(6, 78, 59, 0.12);
        border-radius: 999px;
        overflow: hidden;
        margin-bottom: 40px;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        border-radius: 999px;
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .wizard-step {
        display: none;
        animation: stepFade 0.35s ease;
    }
    .wizard-step.active { display: block; }
    @keyframes stepFade {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .step-title { font-size: 1.35rem; font-weight: 700; margin-bottom: 8px; }
    .step-sub { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 28px; line-height: 1.5; }

    /* Category grid */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 14px;
    }
    @media (max-width: 500px) { .category-grid { grid-template-columns: repeat(2, 1fr); } }
    .category-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 24px 16px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.25s ease;
        font-family: inherit;
        text-align: center;
    }
    .category-card:hover {
        border-color: var(--primary);
        background: #f0fdf4;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px -8px rgba(6, 78, 59, 0.25);
    }
    .category-card.selected {
        border-color: var(--primary);
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.15);
    }
    .category-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(6, 78, 59, 0.08);
        border-radius: 12px;
        color: var(--primary);
        font-size: 1.5rem;
    }
    .category-card.selected .category-icon {
        background: var(--primary);
        color: white;
    }
    .category-name { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }

    /* Full-screen dropzone */
    .upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 20px;
        padding: 48px 24px;
        text-align: center;
        background: rgba(255,255,255,0.7);
        cursor: pointer;
        transition: all 0.25s;
        min-height: 320px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: var(--primary);
        background: rgba(240, 253, 244, 0.6);
    }
    .upload-zone i.fa-camera { font-size: 3rem; color: var(--primary); margin-bottom: 16px; }
    .upload-zone h4 { margin: 0 0 6px; font-size: 1.1rem; }
    .upload-zone p { margin: 0; font-size: 0.9rem; color: var(--text-muted); }
    .preview-carousel { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .preview-main {
        flex: 1; aspect-ratio: 4/3; min-height: 200px; max-height: 280px; border-radius: 12px; overflow: hidden;
        background: #f1f5f9; display: flex; align-items: center; justify-content: center; position: relative;
    }
    .preview-main img { width: 100%; height: 100%; object-fit: contain; }
    .preview-main-crop {
        position: absolute; bottom: 12px; right: 12px; width: 40px; height: 40px;
        background: rgba(0,0,0,0.6); color: white; border-radius: 10px;
        display: flex; align-items: center; justify-content: center; cursor: pointer; border: none;
        font-size: 1rem; z-index: 2;
    }
    .preview-main-crop:hover { background: var(--primary); }
    .carousel-nav {
        width: 44px; height: 44px; min-width: 44px; border-radius: 50%;
        background: white; border: 2px solid var(--primary); color: var(--primary);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; flex-shrink: 0; transition: all 0.2s;
        position: relative; z-index: 2;
    }
    .carousel-nav:hover:not(:disabled) { background: var(--primary); color: white; }
    .carousel-nav:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }
    .preview-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .preview-thumb {
        width: 64px; height: 64px; border-radius: 10px; overflow: visible;
        border: 2px solid transparent; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .preview-thumb.active { border-color: var(--primary); }
    .preview-thumb img { width: 100%; height: 100%; object-fit: contain; background: #f1f5f9; border-radius: 8px; }
    /* Crop modal */
    .crop-modal-overlay {
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        z-index: 2000; align-items: center; justify-content: center; padding: 16px;
    }
    .crop-modal-overlay.visible { display: flex; }
    .crop-modal {
        background: white; border-radius: 16px; padding: 20px;
        width: min(500px, 94vw); max-height: 90vh;
        display: flex; flex-direction: column; gap: 12px; overflow: hidden;
    }
    .crop-modal h3 { margin: 0 0 8px; font-size: 1.1rem; }
    .crop-modal-body { width: 100%; height: min(360px, 60vh); min-height: 260px; background: #f1f5f9; border-radius: 12px; overflow: hidden; position: relative; }
    .crop-modal-body .cropper-container { width: 100% !important; height: 100% !important; max-width: 100% !important; }
    .crop-modal-body .cropper-wrap-box, .crop-modal-body .cropper-view-box { max-width: 100%; }
    .crop-modal-body img { max-width: none; display: block; }
    .crop-modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    .preview-thumb-remove {
        position: absolute; top: -8px; right: -8px; z-index: 3;
        width: 26px; height: 26px; background: #dc2626; color: white;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 12px; cursor: pointer; border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .preview-container { display: none; }
    .preview-container.visible { display: block; }
    .upload-from-computer.hidden { display: none; }

    /* Condition buttons - 3 side by side (override global label uppercase) */
    .condition-btn {
        display: flex; flex-direction: column; align-items: center; text-align: center;
        padding: 24px 20px; border: 2px solid #e2e8f0; border-radius: 16px;
        cursor: pointer; transition: all 0.25s; font-family: inherit;
        text-transform: none;
    }
    .condition-btn:hover { border-color: #cbd5e1; background: #f8fafc; }
    .condition-btn input { position: absolute; opacity: 0; }
    .condition-btn:has(input:checked) {
        border-color: var(--primary); background: #f0fdf4; box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12);
    }
    .condition-btn strong { font-size: 1.15rem; margin-bottom: 6px; font-weight: 600; text-transform: none; }
    .condition-btn span { font-size: 0.88rem; color: var(--text-muted); line-height: 1.4; }
    .condition-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    @media (max-width: 560px) { .condition-grid { grid-template-columns: 1fr; } }
    .photos-side-by-side { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    @media (max-width: 600px) { .photos-side-by-side { grid-template-columns: 1fr; } }
    .photos-block { min-height: 200px; }
    .price-input-wrap {
        display: flex; align-items: stretch; border: 2px solid #e2e8f0;
        border-radius: 16px; overflow: hidden; background: white; font-size: 1.5rem;
    }
    .price-input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12); }
    .price-input-wrap .prefix { padding: 20px 24px; background: #f1f5f9; font-weight: 700; color: var(--text-muted); display: flex; align-items: center; }
    .price-input-wrap input { border: none; border-radius: 0; box-shadow: none; flex: 1; padding: 20px 24px; font-size: 1.5rem; font-weight: 600; min-height: 0; min-width: 0; }
    .wizard-step input[type="text"]:not(#price-input):not(#payout-handle-input):not(#payout-handle-confirm-input),
    .wizard-step textarea {
        width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px;
        font-size: 1rem; font-family: inherit; margin-bottom: 16px;
    }
    .wizard-step input[type="text"]:not(#price-input):not(#payout-handle-input):not(#payout-handle-confirm-input):focus, .wizard-step textarea:focus {
        outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12);
    }

    /* Location - large full-width buttons */
    .location-btn {
        display: flex; align-items: center; justify-content: center; gap: 14px;
        padding: 28px 24px; border: 2px solid #e2e8f0; border-radius: 16px;
        cursor: pointer; transition: all 0.25s; width: 100%; font-family: inherit;
        font-weight: 600; font-size: 1.1rem; text-transform: none;
    }
    .location-btn:hover { border-color: #cbd5e1; background: #f8fafc; }
    .location-btn input { position: absolute; opacity: 0; }
    .location-btn i { color: var(--primary); font-size: 1.5rem; }
    .location-btn:has(input:checked) {
        border-color: var(--primary); background: #f0fdf4; color: var(--primary);
    }
    .location-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    @media (max-width: 500px) { .location-buttons { grid-template-columns: 1fr; } }
    .location-btn { width: 100%; }
    .location-details { display: none; margin-top: 24px; }
    .location-details.visible { display: block; }
    .location-fields { display: none; margin-top: 0; }
    .location-fields.visible { display: block; margin-top: 20px; }

    /* Payout method */
    .payout-method-btns { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .payout-method-btn {
        display: flex; align-items: center; justify-content: center;
        position: relative; /* for absolute input positioning */
        padding: 18px 28px; border: 2px solid #e2e8f0; border-radius: 12px;
        cursor: pointer; font-weight: 600; font-family: inherit; text-transform: none;
        flex: 1; min-width: 100px; transition: all 0.2s;
    }
    .payout-method-btn:hover { border-color: #cbd5e1; background: #f8fafc; }
    .payout-method-btn input {
        position: absolute; inset: 0; width: 100%; height: 100%;
        margin: 0; opacity: 0; cursor: pointer; z-index: 1;
    }
    .payout-method-btn:has(input:checked) {
        border-color: var(--primary); background: #f0fdf4; color: var(--primary);
    }
    .payout-input-wrap {
        display: flex; align-items: stretch; border: 2px solid #e2e8f0;
        border-radius: 12px; overflow: hidden; background: white;
    }
    .payout-input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12); }
    .payout-prefix {
        display: flex; align-items: center; justify-content: center;
        min-width: 48px; padding: 0 16px; background: #f1f5f9;
        font-weight: 700; color: var(--text-muted); font-size: 1.1rem;
    }
    .payout-input-wrap input {
        flex: 1; border: none; border-radius: 0; box-shadow: none;
        padding: 18px 20px; font-size: 1.1rem; min-height: 0;
    }
    .payout-input-wrap input:focus { outline: none; }

    .tier-card {
        padding: 32px 28px; border-radius: 20px; border: 2px solid #e2e8f0;
        transition: all 0.25s; cursor: pointer; position: relative;
        min-height: 200px; display: flex; flex-direction: column;
    }
    .tier-card:hover { border-color: #cbd5e1; transform: translateY(-2px); }
    .tier-card.selected { border-color: var(--primary); background: #f0fdf4; box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12); }
    .tier-card.recommended {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.2);
    }
    .tier-card.recommended.selected { box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12); }
    .tier-card-wrapper { position: relative; }
    .tier-badge {
        position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
        font-size: 0.7rem; font-weight: 800; letter-spacing: 0.05em;
        color: white; background: var(--accent);
        padding: 6px 14px; border-radius: 8px;
        z-index: 2;
    }
    .tier-card h4 { margin: 0 0 6px; font-size: 1.25rem; font-weight: 800; }
    .tier-card .tier-sub { font-size: 0.95rem; color: var(--text-muted); margin-bottom: 16px; line-height: 1.4; }
    .tier-fee-callout {
        padding: 16px 20px; background: rgba(6, 78, 59, 0.08);
        border-radius: 12px; margin-bottom: 18px;
    }
    .tier-fee-callout .payout-hero { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: block; margin-bottom: 4px; }
    .tier-fee-callout .payout-sub { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }
    .tier-fee-callout.free { background: rgba(5, 150, 105, 0.1); }
    .tier-fee-callout.free .payout-hero { color: #059669; }
    .tier-price { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 12px; }
    .tier-list { list-style: none; padding: 0; margin: 0; font-size: 0.95rem; color: var(--text-muted); line-height: 1.9; flex: 1; }
    .tier-list li::before { content: "✓ "; color: var(--primary); font-weight: 700; }
    .tier-list.plus li::before { content: "+ "; color: var(--primary); font-weight: 700; }
    .tier-hero-img-wrap {
        text-align: center;
        margin-bottom: 24px;
    }
    .tier-hero-img {
        max-width: 100%;
        width: min(480px, 90vw);
        height: auto;
        border-radius: 16px;
        object-fit: contain;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .tier-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    @media (max-width: 560px) {
        .tier-grid { grid-template-columns: 1fr; }
        .tier-card { min-height: auto; }
    }

    /* Review step */
    .review-block {
        background: white; border: 1px solid #e2e8f0; border-radius: 16px;
        padding: 24px; margin-bottom: 20px;
    }
    .review-block h5 { margin: 0 0 12px; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 0.03em; }
    .review-block p { margin: 0; font-size: 1rem; font-weight: 600; }
    .review-photos {
        display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;
    }
    .review-photos img {
        width: 80px; height: 80px; object-fit: cover; border-radius: 10px;
        border: 2px solid #e2e8f0;
    }

    /* Inline validation error */
    .wizard-nav-wrap {
        margin-top: 40px;
        padding-top: 24px;
        border-top: 1px solid #e2e8f0;
    }
    .wizard-validation-error {
        display: none;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: #fff7ed;
        border: 1px solid #fed7aa;
        border-radius: 10px;
        color: #c2410c;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 12px;
    }
    .wizard-validation-error.visible {
        display: flex;
    }
    .wizard-validation-error i {
        font-size: 1rem;
        flex-shrink: 0;
    }

    /* Nav */
    .wizard-nav {
        display: flex; justify-content: space-between; align-items: center;
    }
    .btn-back { background: transparent; color: var(--text-muted); border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; padding: 12px 0; }
    .btn-back:hover { color: var(--primary); }

    @media (max-width: 480px) {
        .onboard-wizard .wizard-container { padding: 20px 16px 60px; }
        .upload-zone { min-height: 260px; padding: 32px 16px; }
        .price-input-wrap,
        .price-input-wrap input { font-size: 16px; }
        .price-input-wrap .prefix { padding: 14px 16px; }
        .price-input-wrap input { padding: 14px 16px; }
        .payout-method-btns { flex-direction: column; }
        .payout-method-btn { min-width: 100%; }
    }
</style>

<div class="wizard-container" data-is-guest="{{ 'true' if is_guest else 'false' }}">
    {% if pickup_ended %}
    <div class="wizard-header">
        <h1>Pickup Period Has Ended</h1>
        <p class="sub">Check back next year when signups open for the new season.</p>
    </div>
    <div style="text-align: center; padding: 40px 24px;">
        <p style="color: var(--text-muted); margin-bottom: 24px;">We've saved your account. We'll notify you when it's time to list items again.</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary" style="display: inline-block; padding: 14px 28px;">Back to Home</a>
    </div>
    {% else %}
    <div class="wizard-header">
        <h1>List Your First Item</h1>
        <p class="sub">Quick setup. We'll walk you through it.</p>
    </div>
    <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-fill" style="width: 10%;"></div>
    </div>

    <form method="POST" action="{{ url_for('onboard_guest_save') if is_guest else url_for('onboard') }}" enctype="multipart/form-data" id="onboard-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="quality" id="quality-input" value="4">
        <input type="file" name="photos" id="file-input" accept="image/jpeg,image/png,image/webp" multiple style="display:none;">
        <input type="hidden" name="temp_photo_ids" id="temp-photo-ids" value="">

        <!-- Step 1: Category -->
        <div class="wizard-step active" id="step-1" data-step="1">
            <h2 class="step-title">Which of these best describes what you're selling?</h2>
            <p class="step-sub">Don't worry, you can always edit details or upload more items later.</p>
            {% include '_category_grid.html' %}
        </div>

        <!-- Step 2: Condition -->
        <div class="wizard-step" id="step-2" data-step="2">
            <h2 class="step-title">What condition is your item in?</h2>
            <p class="step-sub">Be honest. Buyers appreciate accuracy.</p>
            <div class="condition-grid">
                <label class="condition-btn">
                    <input type="radio" name="condition_radio" value="like_new" data-quality="5">
                    <strong>Like new</strong>
                    <span>Used once or twice, perfect condition.</span>
                </label>
                <label class="condition-btn">
                    <input type="radio" name="condition_radio" value="4" data-quality="4">
                    <strong>Good</strong>
                    <span>Minor signs of wear, fully functional.</span>
                </label>
                <label class="condition-btn">
                    <input type="radio" name="condition_radio" value="3" data-quality="3">
                    <strong>Fair</strong>
                    <span>Visible wear, but still usable.</span>
                </label>
            </div>
        </div>

        <!-- Step 3: Photos -->
        <div class="wizard-step" id="step-3" data-step="3">
            <h2 class="step-title">Add photos</h2>
            <p class="step-sub">Show off your item. Make sure to capture any wear or tear! We recommend taking at least two photos.</p>
            <div class="photos-side-by-side">
                <div id="upload-from-computer" class="upload-zone photos-block">
                    <i class="fas fa-camera"></i>
                    <h4>Click to upload photos</h4>
                    <p>or drag and drop • JPG, PNG, or WebP</p>
                </div>
                <div id="qr-block" class="upload-zone photos-block" style="background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 100%);border-color:rgba(6,78,59,0.3);">
                    <i class="fas fa-qrcode" style="color:var(--primary);font-size:1.5rem;margin-bottom:8px;"></i>
                    <h4 style="color:var(--primary);">Upload with your phone</h4>
                    <p style="margin-bottom:12px;">Scan with your camera</p>
                    <div id="qr-container" style="min-height:140px;display:flex;align-items:center;justify-content:center;"></div>
                </div>
            </div>
            <div class="preview-container" id="preview-container">
                <div class="preview-carousel">
                    <button type="button" class="carousel-nav" id="prev-btn"><i class="fas fa-chevron-left"></i></button>
                    <div class="preview-main" id="preview-main">
                        <img id="main-preview" src="" alt="" style="display:none;">
                        <div id="no-preview" style="color:var(--text-muted);"><i class="fas fa-image" style="font-size:2.5rem;margin-bottom:8px;"></i><p>No preview</p></div>
                        <button type="button" class="preview-main-crop" id="main-crop-btn" title="Adjust photo" style="display:none;"><i class="fas fa-crop"></i></button>
                    </div>
                    <button type="button" class="carousel-nav" id="next-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="preview-thumbnails" id="thumbnails"></div>
                <p style="font-size:0.9rem;color:var(--text-muted);margin:12px 0 0;"><i class="fas fa-images"></i> <span id="file-count-text">0 photos</span> • Star your cover by clicking a thumbnail</p>
                <button type="button" id="add-more-btn" style="margin-top:12px;padding:10px 20px;background:#f8fafc;border:2px dashed #cbd5e1;border-radius:10px;color:var(--primary);font-weight:600;cursor:pointer;font-size:0.9rem;"><i class="fas fa-plus"></i> Add more</button>
            </div>
        </div>

        <!-- Step 4: Title -->
        <div class="wizard-step" id="step-4" data-step="4">
            <h2 class="step-title">Let's give your item a name</h2>
            <p class="step-sub">Brief and specific works best. (e.g. Insignia 55&quot; flatscreen TV)</p>
            <input type="text" name="description" id="title-input" placeholder="e.g. Insignia 55&quot; flatscreen TV" required maxlength="200">
        </div>

        <!-- Step 5: Description -->
        <div class="wizard-step" id="step-5" data-step="5">
            <h2 class="step-title">Anything we should know?</h2>
            <p class="step-sub">Dimensions, flaws, or special details. The more specific, the better.</p>
            <textarea name="long_description" rows="4" placeholder="e.g. 47&quot;W x 24&quot;D. Small scratch on left leg. Includes assembly hardware."></textarea>
        </div>

        <!-- Step 6: Pricing -->
        <div class="wizard-step" id="step-6" data-step="6">
            <h2 class="step-title">How much do you want to list this for?</h2>
            <p class="step-sub">You suggest a price. We review each item and may adjust the price based on brand, condition, and market. You'll see the final price when we approve your listing.</p>
            <div class="price-input-wrap">
                <span class="prefix">$</span>
                <input type="text" name="suggested_price" id="price-input" placeholder="0" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" autocomplete="off">
            </div>
            <p class="price-disclaimer" style="font-size:0.85rem; color:var(--text-muted); margin-top:12px; line-height:1.5;">This is just a recommendation. Every item is different. We take into account brand, quality, and market trends when setting final prices.</p>
        </div>

        <!-- Step 8: Payout (Venmo / PayPal / Zelle) -->
        <div class="wizard-step" id="step-8" data-step="8">
            <h2 class="step-title">How would you like to get paid?</h2>
            <p class="step-sub">We'll send your earnings here once the item sells.</p>
            <div class="payout-method-btns">
                <label class="payout-method-btn">
                    <input type="radio" name="payout_method" value="Venmo" {% if not current_user.is_authenticated or not current_user.payout_method or current_user.payout_method == 'Venmo' %}checked{% endif %}>
                    <span>Venmo</span>
                </label>
                <label class="payout-method-btn">
                    <input type="radio" name="payout_method" value="PayPal" {% if current_user.is_authenticated and current_user.payout_method == 'PayPal' %}checked{% endif %}>
                    <span>PayPal</span>
                </label>
                <label class="payout-method-btn">
                    <input type="radio" name="payout_method" value="Zelle" {% if current_user.is_authenticated and current_user.payout_method == 'Zelle' %}checked{% endif %}>
                    <span>Zelle</span>
                </label>
            </div>
            <div id="payout-input-wrap" class="payout-input-wrap">
                <span id="payout-prefix" class="payout-prefix">@</span>
                <input type="text" name="payout_handle" id="payout-handle-input" value="{% if current_user.is_authenticated %}{{ current_user.payout_handle or '' }}{% endif %}" placeholder="username" required>
            </div>
            <label style="margin-top:16px;display:block;font-size:0.9rem;">Confirm handle</label>
            <div id="payout-input-wrap-confirm" class="payout-input-wrap" style="margin-top:6px;">
                <span id="payout-prefix-confirm" class="payout-prefix">@</span>
                <input type="text" name="payout_handle_confirm" id="payout-handle-confirm-input" placeholder="username" required>
            </div>
            <p id="payout-hint" class="payout-hint" style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">Venmo username (without @)</p>
        </div>

        <!-- Step 7: Service Tier (moved before address) -->
        <div class="wizard-step" id="step-7" data-step="7">
            <h2 class="step-title">How do you want to sell?</h2>
            <p class="step-sub">Choose the plan that works best for you. You can always upgrade later.</p>
            <div class="tier-hero-img-wrap">
                <img src="{{ url_for('static', filename='campusSwapPickup.png') }}" alt="Campus Swap Movers" class="tier-hero-img">
            </div>
            <div class="tier-grid" style="grid-template-columns: 1fr 1fr;">
                <!-- Free Tier -->
                <div class="tier-card-wrapper">
                    <div class="tier-card" id="tier-free" data-tier="free" style="border-color: #cbd5e1;">
                        <h4 style="color:#475569;">Free Plan</h4>
                        <p class="tier-sub">Free moveout, lower cut.</p>
                        <div class="tier-fee-callout" style="background:#f8fafc;">
                            <span class="payout-hero" style="color:#475569;">20% of sale price</span>
                            <span class="payout-sub">$0 — no fee ever</span>
                        </div>
                        <ul class="tier-list">
                            <li>Upload up to {{ free_tier_max_items }} items.</li>
                            <li>We confirm by April 20th if we have room. Paid users get priority pickup.</li>
                        </ul>
                    </div>
                </div>
                <!-- Campus Swap Pickup -->
                <div class="tier-card-wrapper">
                    <span class="tier-badge" style="background:#b45309;">★ Recommended</span>
                    <div class="tier-card recommended" id="tier-pickup" data-tier="online" style="border-color:#d97706;">
                        <h4 style="color:#92400e;">Pro Plan</h4>
                        <p class="tier-sub">Guaranteed pickup &amp; the best payout.</p>
                        <div class="tier-fee-callout" style="background:#fffbeb;">
                            <span class="payout-hero" style="color:#92400e;">50% of sale price</span>
                            <span class="payout-sub">$15 one-time pickup fee</span>
                        </div>
                        <ul class="tier-list plus">
                            <li>We drive to you — guaranteed.</li>
                            <li>Unlimited items per pickup.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <input type="hidden" name="collection_method" id="collection-method-input" value="online">
        </div>

        <!-- Step 9: Review -->
        <div class="wizard-step" id="step-9" data-step="9">
            <h2 class="step-title">Review & publish</h2>
            <p class="step-sub">Almost done! Double-check and hit publish.</p>
            <div class="review-block">
                <h5>Photos</h5>
                <div id="review-photos" class="review-photos"></div>
            </div>
            <div class="review-block">
                <h5>Item</h5>
                <p id="review-category"></p>
                <p id="review-description" style="font-weight:500;margin-top:4px;"></p>
                <p id="review-long-description" style="font-size:0.95rem;margin-top:8px;color:var(--text-muted);line-height:1.5;white-space:pre-wrap;"></p>
                <p id="review-condition" style="font-size:0.95rem;margin-top:4px;"></p>
                <p id="review-price" style="font-size:0.95rem;margin-top:8px;"></p>
            </div>

            <div class="review-block">
                <h5>Payout</h5>
                <p id="review-venmo"></p>
            </div>
            <div class="review-block">
                <h5>Service</h5>
                <p id="review-tier"></p>
            </div>
            <button type="button" class="btn btn-primary" style="width:100%;padding:18px;font-size:1.1rem;" id="publish-btn">
                <i class="fas fa-check"></i> {% if is_guest %}Continue{% else %}Submit Listing for Approval{% endif %}
            </button>
        </div>
    </form>

        {% if is_guest %}
        <!-- Step 11: Create account (guests only) - embedded in wizard -->
        <div class="wizard-step" id="step-11" data-step="11">
            <h2 class="step-title">Last step, create an account to secure your listing</h2>
            <p class="step-sub">Your listing is ready. Create an account to submit it for approval.</p>
            {% if google_oauth_enabled %}
            <a href="/auth/google" class="btn-google" style="margin-bottom: 16px; display: inline-flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </a>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin: 10px 0 16px; text-align: center;">or sign up with email</p>
            {% endif %}
            <form method="POST" action="{{ url_for('register', from_onboard=1) }}" id="create-account-form" class="step-11-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="from_onboard" value="1"/>
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 500; font-size: 0.9rem;">Full Name</label>
                    <input type="text" name="full_name" placeholder="Your full name" required style="width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 500; font-size: 0.9rem;">Email Address</label>
                    <input type="email" name="email" placeholder="your@email.com" required style="width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 500; font-size: 0.9rem;">Password</label>
                    <input type="password" name="password" placeholder="Choose a password (min 6 characters)" required minlength="6" style="width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem;">
                </div>
                {% if turnstile_site_key %}
                <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
                <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" style="margin: 16px 0;"></div>
                {% endif %}
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px;">Create Account</button>
            </form>
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px;">Already have an account?</p>
                <a href="{{ url_for('login') }}" class="btn btn-outline" style="width: 100%; display: inline-block; text-align: center;">Log In</a>
            </div>
        </div>
        {% endif %}

    <div class="wizard-nav-wrap">
    <div id="wizard-validation-error" class="wizard-validation-error" role="alert">
        <i class="fas fa-exclamation-circle"></i>
        <span id="wizard-validation-message"></span>
    </div>
    <div class="wizard-nav" id="wizard-nav">
        <button type="button" class="btn-back" id="btn-back" style="visibility:hidden;"><i class="fas fa-arrow-left"></i> Back</button>
        <button type="button" class="btn btn-primary" id="btn-next">Next</button>
    </div>
    </div>
    {% endif %}
</div>

{% if not pickup_ended %}
<!-- Crop modal -->
<div id="crop-modal-overlay" class="crop-modal-overlay">
    <div class="crop-modal">
        <h3>Adjust your photo</h3>
        <p style="margin:0;font-size:0.95rem;color:var(--text-muted);">Drag the image to reposition. When it looks good, tap Apply.</p>
        <div class="crop-modal-body">
            <img id="crop-image" src="" alt="">
        </div>
        <div class="crop-modal-actions">
            <button type="button" class="btn btn-outline" id="crop-cancel">Cancel</button>
            <button type="button" class="btn btn-primary" id="crop-apply"><i class="fas fa-check"></i> Apply</button>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
{% if google_maps_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=places" async defer></script>
<script>
    (function() {
        var key = '{{ google_maps_key }}';
        if (key && document.getElementById('pickup_address')) {
            function initPlaces() {
                if (typeof google === 'undefined' || !google.maps || !google.maps.places) return;
                var addressInput = document.getElementById('pickup_address');
                var mapContainer = document.getElementById('pickup-map-container');
                var mapIframe = document.getElementById('pickup-map-iframe');
                function updateMap(url) {
                    if (mapIframe && url) {
                        mapIframe.src = url;
                        if (mapContainer) mapContainer.style.display = 'block';
                    } else if (mapContainer) {
                        mapContainer.style.display = 'none';
                    }
                }
                var ac = new google.maps.places.Autocomplete(addressInput, { types: ['address'] });
                ac.addListener('place_changed', function() {
                    var place = ac.getPlace();
                    if (place.geometry && place.geometry.location) {
                        document.getElementById('pickup_lat').value = place.geometry.location.lat();
                        document.getElementById('pickup_lng').value = place.geometry.location.lng();
                    }
                    var addr = place.formatted_address || addressInput.value;
                    if (addr && key) {
                        var embedUrl = 'https://www.google.com/maps/embed/v1/place?key=' + encodeURIComponent(key) + '&q=' + encodeURIComponent(addr);
                        updateMap(embedUrl);
                    }
                });
                if (addressInput.value && key) {
                    var q = encodeURIComponent(addressInput.value);
                    updateMap('https://www.google.com/maps/embed/v1/place?key=' + encodeURIComponent(key) + '&q=' + q);
                }
            }
            if (typeof google !== 'undefined' && google.maps) initPlaces();
            else window.addEventListener('load', function() { setTimeout(initPlaces, 500); });
        }
    })();
</script>
{% endif %}
<script>
(function() {
    const isGuest = document.querySelector('.wizard-container').dataset.isGuest === 'true';
    const TOTAL_STEPS = isGuest ? 10 : 9;
    let currentStep = 1;
    let selectedFiles = [];
    let tempPhotoFilenames = [];
    let tempPhotoUrls = {};
    let currentImageIndex = 0;
    let uploadSessionToken = null;
    let uploadSessionPollInterval = null;

    const progressFill = document.getElementById('progress-fill');
    const btnNext = document.getElementById('btn-next');
    const btnBack = document.getElementById('btn-back');
    const fileInput = document.getElementById('file-input');
    const uploadZone = document.getElementById('upload-from-computer');
    const previewContainer = document.getElementById('preview-container');
    const form = document.getElementById('onboard-form');
    const validationErrorEl = document.getElementById('wizard-validation-error');
    const validationMessageEl = document.getElementById('wizard-validation-message');

    function showValidationError(msg) {
        validationMessageEl.textContent = msg;
        validationErrorEl.classList.add('visible');
        validationErrorEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
    function hideValidationError() {
        validationErrorEl.classList.remove('visible');
    }

    function goStep(step) {
        hideValidationError();
        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
        const s = document.getElementById('step-' + step);
        if (s) s.classList.add('active');
        progressFill.style.width = (step / TOTAL_STEPS * 100) + '%';
        currentStep = step;
        btnBack.style.visibility = step > 1 ? 'visible' : 'hidden';
        if (step === 3 && !uploadSessionToken) {
            loadQr();
        }
        if (step >= 9) {
            btnNext.style.display = 'none';
            if (step === 9) populateReview();
        } else {
            btnNext.style.display = 'flex';
            btnNext.textContent = 'Next';
        }
        window.scrollTo(0, 0);
    }

    function validateStep(step) {
        if (step === 1) {
            const id = document.getElementById('category-id-input').value;
            if (!id) { showValidationError('Please select a category that best describes what you\'re selling before continuing.'); return false; }
        }
        if (step === 2) {
            const q = document.querySelector('input[name="condition_radio"]:checked');
            if (!q) { showValidationError('Please select the condition of your item before continuing.'); return false; }
            document.getElementById('quality-input').value = q.dataset.quality || q.value;
        }
        if (step === 3) {
            const total = selectedFiles.length + tempPhotoFilenames.length;
            if (total === 0) { showValidationError('Please add photos before continuing.'); return false; }
        }
        if (step === 4) {
            const desc = form.querySelector('input[name="description"]').value.trim();
            if (!desc) { showValidationError('Please give your item a name before continuing.'); return false; }
        }
        if (step === 7) {
            // Tier selection validation
            const tierMethod = document.getElementById('collection-method-input').value;
            if (!tierMethod) { showValidationError('Please select a plan before continuing.'); return false; }
        }
        if (step === 8) {
            const method = form.querySelector('input[name="payout_method"]:checked');
            const handle = form.querySelector('input[name="payout_handle"]').value.trim();
            const confirmHandle = form.querySelector('input[name="payout_handle_confirm"]').value.trim();
            if (!handle) { showValidationError('Please enter your payout information before continuing.'); return false; }
            if (method && method.value === 'Venmo' && !handle.replace(/^@/,'').trim()) {
                showValidationError('Please enter your Venmo username before continuing.'); return false;
            }
            const norm = (s) => (method && method.value === 'Venmo' ? s.replace(/^@/,'').trim().toLowerCase() : s.trim().toLowerCase());
            if (norm(handle) !== norm(confirmHandle)) {
                showValidationError('Handles do not match. Please re-enter to confirm.');
                return false;
            }
        }
        return true;
    }

    btnNext.addEventListener('click', function() {
        if (!validateStep(currentStep)) return;
        if (currentStep < TOTAL_STEPS) goStep(currentStep + 1);
    });
    btnBack.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentStep > 1) goStep(currentStep - 1);
    });

    // Category selection
    document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('category-id-input').value = this.dataset.categoryId;
            hideValidationError();
        });
    });

    // Condition selection
    document.querySelectorAll('input[name="condition_radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const q = this.dataset.quality || (this.value === 'like_new' ? '5' : this.value);
            document.getElementById('quality-input').value = q;
            hideValidationError();
        });
    });

    // Tier selection
    document.querySelectorAll('.tier-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.tier-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('collection-method-input').value = this.dataset.tier;
            hideValidationError();
        });
    });
    document.getElementById('tier-pickup').classList.add('selected');



    // Payout method toggle - update prefix and placeholder
    function syncPayoutUI() {
        const checked = form.querySelector('input[name="payout_method"]:checked');
        if (!checked) return;
        const prefix = document.getElementById('payout-prefix');
        const prefixConfirm = document.getElementById('payout-prefix-confirm');
        const input = document.getElementById('payout-handle-input');
        const inputConfirm = document.getElementById('payout-handle-confirm-input');
        const hint = document.getElementById('payout-hint');
        if (checked.value === 'Venmo') {
            prefix.textContent = prefixConfirm.textContent = '@';
            prefix.style.display = prefixConfirm.style.display = 'flex';
            input.placeholder = inputConfirm.placeholder = 'username';
            hint.textContent = 'Venmo username (without @)';
        } else if (checked.value === 'PayPal') {
            prefix.textContent = prefixConfirm.textContent = '';
            prefix.style.display = prefixConfirm.style.display = 'none';
            input.placeholder = inputConfirm.placeholder = 'your@email.com';
            hint.textContent = 'PayPal email address';
        } else {
            prefix.textContent = prefixConfirm.textContent = '';
            prefix.style.display = prefixConfirm.style.display = 'none';
            input.placeholder = inputConfirm.placeholder = 'email or phone';
            hint.textContent = 'Zelle email or phone number';
        }
    }
    form.querySelectorAll('input[name="payout_method"]').forEach(radio => {
        radio.addEventListener('change', function() { syncPayoutUI(); hideValidationError(); });
    });
    syncPayoutUI();



    // Hide validation error when user corrects step 4, 7, 8 inputs
    document.getElementById('price-input')?.addEventListener('input', function() {
        let v = this.value.replace(/[^0-9.]/g, '');
        const parts = v.split('.');
        if (parts.length > 2) v = parts[0] + '.' + parts.slice(1).join('');
        if (parts.length === 2 && parts[1].length > 2) v = parts[0] + '.' + parts[1].slice(0, 2);
        this.value = v;
    });
    form.querySelector('input[name="description"]')?.addEventListener('input', hideValidationError);
    document.getElementById('payout-handle-input')?.addEventListener('input', hideValidationError);
    document.getElementById('payout-handle-confirm-input')?.addEventListener('input', hideValidationError);

    // Populate review
    function populateReview() {
        // Review photos
        const reviewPhotos = document.getElementById('review-photos');
        reviewPhotos.innerHTML = '';
        const items = getAllDisplayItems();
        items.forEach((item, idx) => {
            const img = document.createElement('img');
            img.alt = 'Photo ' + (idx + 1);
            if (item.type === 'file') {
                const r = new FileReader();
                r.onload = e => { img.src = e.target.result; };
                r.readAsDataURL(item.file);
            } else {
                img.src = item.url || '';
            }
            reviewPhotos.appendChild(img);
        });
        if (items.length === 0) reviewPhotos.innerHTML = '<p style="color:var(--text-muted);font-size:0.9rem;">No photos</p>';

        const catCard = document.querySelector('.category-card.selected');
        document.getElementById('review-category').textContent = catCard ? catCard.dataset.categoryName : '';
        const titleVal = form.querySelector('input[name="description"]').value || '';
        document.getElementById('review-description').textContent = titleVal ? 'Title: ' + titleVal : '';
        const longDesc = (form.querySelector('textarea[name="long_description"]') || {}).value || '';
        const longDescEl = document.getElementById('review-long-description');
        longDescEl.textContent = longDesc ? 'Description: ' + longDesc : '';
        longDescEl.style.display = longDesc ? 'block' : 'none';
        const condRadio = form.querySelector('input[name="condition_radio"]:checked');
        const condMap = { 'like_new': 'Like new', '4': 'Good', '3': 'Fair', '5': 'Like new' };
        document.getElementById('review-condition').textContent = condRadio ? 'Condition: ' + (condMap[condRadio.value] || condRadio.value) : '';
        const priceVal = form.querySelector('input[name="suggested_price"]').value;
        const priceNum = parseFloat(priceVal);
        document.getElementById('review-price').textContent = priceVal && !isNaN(priceNum) ? 'Suggested Price: $' + priceNum.toFixed(2) : 'No suggested price';

        const pm = form.querySelector('input[name="payout_method"]:checked');
        const ph = form.querySelector('input[name="payout_handle"]').value.replace('@','').trim();
        const payoutText = pm && ph ? (pm.value === 'Venmo' ? 'Venmo: @' + ph : pm.value + ': ' + ph) : '';
        document.getElementById('review-venmo').textContent = payoutText;
        const tier = document.getElementById('collection-method-input').value;
        const tierLabel = tier === 'online' ? 'Pro Plan (50%)' : 'Free Plan (20%)';
        document.getElementById('review-tier').textContent = tierLabel;
        // Show/hide location in review based on tier
        const reviewLocBlock = document.getElementById('review-loc-block');
        if (reviewLocBlock) reviewLocBlock.style.display = (tier === 'online') ? '' : 'none';
    }

    // Photo upload - preserve add_item logic
    function getTotalPhotoCount() { return selectedFiles.length + tempPhotoFilenames.length; }
    function getAllDisplayItems() {
        const fileItems = selectedFiles.map(f => ({ type: 'file', file: f }));
        const tempItems = tempPhotoFilenames.map(fn => ({ type: 'temp', filename: fn, url: tempPhotoUrls[fn] }));
        return fileItems.concat(tempItems);
    }
    function addTempPhotos(filenames, urls) {
        filenames.filter(fn => !tempPhotoFilenames.includes(fn)).forEach(fn => {
            tempPhotoFilenames.push(fn);
            tempPhotoUrls[fn] = urls[filenames.indexOf(fn)] || '';
        });
        document.getElementById('temp-photo-ids').value = tempPhotoFilenames.join(',');
        updatePreviews();
        previewContainer.classList.add('visible');
        hideValidationError();
    }
    function removeTempPhoto(filename) {
        tempPhotoFilenames = tempPhotoFilenames.filter(f => f !== filename);
        delete tempPhotoUrls[filename];
        document.getElementById('temp-photo-ids').value = tempPhotoFilenames.join(',');
        if (getTotalPhotoCount() === 0) {
            previewContainer.classList.remove('visible');
        } else updatePreviews();
    }
    function updatePreviews() {
        const total = getTotalPhotoCount();
        document.getElementById('file-count-text').textContent = total + ' photo' + (total !== 1 ? 's' : '');
        const thumbnails = document.getElementById('thumbnails');
        thumbnails.innerHTML = '';
        const items = getAllDisplayItems();
        items.forEach((item, idx) => {
            const thumb = document.createElement('div');
            thumb.className = 'preview-thumb' + (idx === currentImageIndex ? ' active' : '');
            thumb.style.position = 'relative';
            const img = document.createElement('img');
            if (item.type === 'file') {
                const r = new FileReader();
                r.onload = e => { img.src = e.target.result; };
                r.readAsDataURL(item.file);
            } else img.src = item.url;
            thumb.appendChild(img);
            const rm = document.createElement('div');
            rm.className = 'preview-thumb-remove';
            rm.innerHTML = '<i class="fas fa-times"></i>';
            rm.onclick = ev => { ev.stopPropagation(); removeImageOrTemp(idx); };
            thumb.appendChild(rm);
            thumb.onclick = () => showImage(idx);
            thumbnails.appendChild(thumb);
        });
        if (items.length) {
            const it = items[currentImageIndex];
            if (it.type === 'file') {
                const r = new FileReader();
                r.onload = e => { document.getElementById('main-preview').src = e.target.result; document.getElementById('main-preview').style.display = 'block'; document.getElementById('no-preview').style.display = 'none'; };
                r.readAsDataURL(it.file);
            } else {
                document.getElementById('main-preview').src = it.url;
                document.getElementById('main-preview').style.display = 'block';
                document.getElementById('no-preview').style.display = 'none';
            }
        }
        const showArrows = items.length > 1;
        document.getElementById('prev-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('next-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('prev-btn').disabled = currentImageIndex === 0;
        document.getElementById('next-btn').disabled = currentImageIndex >= items.length - 1;
        const mainCropBtn = document.getElementById('main-crop-btn');
        if (mainCropBtn) {
            const cur = items[currentImageIndex];
            mainCropBtn.style.display = (cur && cur.type === 'file') ? 'flex' : 'none';
        }
    }
    function showImage(idx) {
        const items = getAllDisplayItems();
        if (idx < 0 || idx >= items.length) return;
        currentImageIndex = idx;
        document.querySelectorAll('.preview-thumb').forEach((t,i) => t.classList.toggle('active', i === idx));
        const it = items[idx];
        if (it.type === 'file') {
            const r = new FileReader();
            r.onload = e => { document.getElementById('main-preview').src = e.target.result; document.getElementById('main-preview').style.display = 'block'; document.getElementById('no-preview').style.display = 'none'; };
            r.readAsDataURL(it.file);
        } else {
            document.getElementById('main-preview').src = it.url;
            document.getElementById('main-preview').style.display = 'block';
            document.getElementById('no-preview').style.display = 'none';
        }
        const showArrows = items.length > 1;
        document.getElementById('prev-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('next-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('prev-btn').disabled = idx === 0;
        document.getElementById('next-btn').disabled = idx >= items.length - 1;
        const mainCropBtn = document.getElementById('main-crop-btn');
        if (mainCropBtn) {
            const cur = items[idx];
            mainCropBtn.style.display = (cur && cur.type === 'file') ? 'flex' : 'none';
        }
    }
    function changeImage(d) {
        const items = getAllDisplayItems();
        const n = currentImageIndex + d;
        if (n >= 0 && n < items.length) showImage(n);
    }
    function removeImageOrTemp(idx) {
        const items = getAllDisplayItems();
        const it = items[idx];
        if (it.type === 'file') {
            selectedFiles = selectedFiles.filter(f => f !== it.file);
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
        } else removeTempPhoto(it.filename);
        currentImageIndex = Math.min(currentImageIndex, getTotalPhotoCount() - 1);
        if (currentImageIndex < 0) currentImageIndex = 0;
        if (getTotalPhotoCount() === 0) {
            previewContainer.classList.remove('visible');
        } else updatePreviews();
    }

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    let cropperInstance = null;
    let cropEditingIndex = null;

    function openCropModal(fileOrUrl, indexForReplace) {
        const imgEl = document.getElementById('crop-image');
        const overlay = document.getElementById('crop-modal-overlay');
        cropEditingIndex = indexForReplace;
        if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
        overlay.classList.add('visible');
        imgEl.onload = function() {
            requestAnimationFrame(function() { initCropper(); });
        };
        if (typeof fileOrUrl === 'string') {
            imgEl.src = fileOrUrl;
            if (imgEl.complete) imgEl.onload();
        } else {
            const r = new FileReader();
            r.onload = e => {
                imgEl.src = e.target.result;
                if (imgEl.complete) imgEl.onload();
            };
            r.readAsDataURL(fileOrUrl);
        }
    }
    function initCropper() {
        const img = document.getElementById('crop-image');
        if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
        cropperInstance = new Cropper(img, {
            aspectRatio: 4/3,
            viewMode: 1,
            autoCropArea: 0.9,
            dragMode: 'move',
            guides: true,
            center: true,
            highlight: false
        });
    }
    function closeCropModal() {
        document.getElementById('crop-modal-overlay').classList.remove('visible');
        if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
        cropEditingIndex = null;
    }
    function addCroppedFile(blob) {
        const name = (cropEditingIndex !== null && selectedFiles[cropEditingIndex] ? selectedFiles[cropEditingIndex].name : null) || 'photo.jpg';
        const ext = name.split('.').pop() || 'jpg';
        const mime = ext === 'png' ? 'image/png' : ext === 'webp' ? 'image/webp' : 'image/jpeg';
        const f = new File([blob], name.replace(/\.[^.]+$/, '_cropped.'+ext) || 'photo.jpg', { type: mime });
        selectedFiles[cropEditingIndex] = f;
        const dt = new DataTransfer();
        selectedFiles.forEach(x => dt.items.add(x));
        fileInput.files = dt.files;
        closeCropModal();
        updatePreviews();
        previewContainer.classList.add('visible');
        hideValidationError();
    }

    document.getElementById('main-crop-btn').addEventListener('click', function() {
        const items = getAllDisplayItems();
        const i = currentImageIndex;
        if (i >= 0 && i < items.length && items[i].type === 'file') openCropModal(items[i].file, i);
    });
    document.getElementById('crop-cancel').addEventListener('click', closeCropModal);
    document.getElementById('crop-apply').addEventListener('click', function() {
        if (!cropperInstance) return;
        const btn = document.getElementById('crop-apply');
        btn.disabled = true;
        try {
            const canvas = cropperInstance.getCroppedCanvas({ maxWidth: 1600, maxHeight: 1200, imageSmoothingQuality: 'high' });
            if (!canvas) { btn.disabled = false; return; }
            canvas.toBlob(function(blob) {
                btn.disabled = false;
                if (blob) addCroppedFile(blob);
            }, 'image/jpeg', 0.9);
        } catch (e) {
            btn.disabled = false;
        }
    });

    uploadZone.addEventListener('drop', e => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        if (files.length) {
            const existing = new Set(selectedFiles.map(f => f.name));
            selectedFiles = selectedFiles.concat(files.filter(f => !existing.has(f.name)));
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
            updatePreviews();
            previewContainer.classList.add('visible');
            hideValidationError();
        }
    });
    fileInput.addEventListener('change', function() {
        const files = Array.from(this.files);
        if (files.length) {
            const existing = new Set(selectedFiles.map(f => f.name));
            selectedFiles = selectedFiles.concat(files.filter(f => !existing.has(f.name)));
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            this.files = dt.files;
            updatePreviews();
            previewContainer.classList.add('visible');
            hideValidationError();
        }
    });
    document.getElementById('add-more-btn').addEventListener('click', () => fileInput.click());

    document.getElementById('prev-btn').addEventListener('click', function() { changeImage(-1); });
    document.getElementById('next-btn').addEventListener('click', function() { changeImage(1); });

    // QR upload (works for both logged-in and guest users)
    async function loadQr() {
        try {
            const fd = new FormData();
            fd.append('csrf_token', form.querySelector('input[name="csrf_token"]').value);
            const r = await fetch('/api/upload_session/create', {
                method: 'POST',
                body: fd,
                credentials: 'same-origin',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const d = await r.json().catch(() => ({}));
            if (r.ok && d.token) {
                uploadSessionToken = d.token;
                document.getElementById('qr-container').innerHTML = '<img src="data:image/png;base64,'+d.qr_code_base64+'" alt="QR" style="max-width:256px;">';
                uploadSessionPollInterval = setInterval(async () => {
                    if (!uploadSessionToken) return;
                    try {
                        const s = await fetch('/api/upload_session/status?token='+encodeURIComponent(uploadSessionToken), { credentials: 'same-origin' });
                        const j = await s.json().catch(() => ({}));
                        if (j.images && j.images.length) {
                            addTempPhotos(j.images.map(i => i.filename), j.images.map(i => i.url));
                        }
                    } catch(e){}
                }, 2500);
            } else {
                document.getElementById('qr-container').innerHTML = '<p style="color:#dc2626;">Could not load. ' + (d.error || (r.status === 500 ? 'Server error.' : '')) + '</p>';
            }
        } catch(e) {
            document.getElementById('qr-container').innerHTML = '<p style="color:#dc2626;">Could not load. Please try again.</p>';
        }
    }
    // QR loads automatically when entering photos step (see goStep)

    // Publish button - ONLY way to submit; prevents accidental submit on Back/Enter
    document.getElementById('publish-btn').addEventListener('click', async function() {
        if (currentStep !== 9) return;
        if (!validateStep(7)) return;  // Re-validate location
        if (!validateStep(8)) return;  // Re-validate Venmo
        if (getTotalPhotoCount() === 0) { showValidationError('Please add photos before continuing.'); return; }
        const desc = form.querySelector('input[name="description"]').value.trim();
        if (!desc) { showValidationError('Please give your item a name before continuing.'); return; }
        const files = fileInput.files;
        if (selectedFiles.length && (!files || !files.length)) {
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
        }
        const phInput = form.querySelector('input[name="payout_handle"]');
        const phConfirmInput = form.querySelector('input[name="payout_handle_confirm"]');
        const pm = form.querySelector('input[name="payout_method"]:checked');
        if (pm && pm.value === 'Venmo') {
            phInput.value = phInput.value.replace(/^@/,'').trim();
            phConfirmInput.value = phConfirmInput.value.replace(/^@/,'').trim();
        }

        if (isGuest) {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            try {
                const fd = new FormData(form);
                const r = await fetch('{{ url_for("onboard_guest_save") }}', {
                    method: 'POST',
                    body: fd,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await r.json().catch(() => ({}));
                if (r.ok && data.success) {
                    goStep(11);
                } else {
                    showValidationError(data.error || 'Something went wrong. Please try again.');
                }
            } catch (e) {
                showValidationError('Something went wrong. Please try again.');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Continue';
        } else {
            form.submit();
        }
    });

    // Block form submit from Enter key or accidental submit - only Publish button submits
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        return false;
    });
})();
</script>
{% endif %}
{% endblock %}

{% extends "layout.html" %}

{% block content %}
<style>
    .remove-confirm-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 16px; }
    .remove-confirm-dialog { background: white; border-radius: 12px; padding: 24px; max-width: 360px; width: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .remove-confirm-msg { margin: 0 0 20px; font-size: 1rem; line-height: 1.5; }
    .remove-confirm-actions { display: flex; gap: 12px; justify-content: flex-end; }
</style>
<div class="container" style="max-width: 800px; margin-top: 40px;">
    <h1>Edit Item</h1>
    
    <div class="card">
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <h3>Details</h3>
            <label>Short Title</label>
            <input type="text" name="description" value="{{ item.description }}" required>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <div>
                    <label>Category</label>
                    <select name="category_id" required>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if item.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label>Condition</label>
                    <select name="quality" required>
                        <option value="5" {% if item.quality == 5 %}selected{% endif %}>Like new – Used once or twice, perfect condition</option>
                        <option value="4" {% if item.quality == 4 %}selected{% endif %}>Good – Minor signs of wear, fully functional</option>
                        <option value="3" {% if item.quality in (1, 2, 3) %}selected{% endif %}>Fair – Visible wear, but still usable</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 15px;">
                <label>Price ($)</label>
                {% if not current_user.is_admin and (item.status in ('pending_logistics', 'rejected') or item_is_picked_up(item)) %}
                <div style="padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; color: var(--text-muted);">
                    {{ '$%.2f'|format(item.price) if item.price else 'Pending' }}
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin: 8px 0 0;">Price set by admin on approval. Submit edits to request re-approval.</p>
                {% else %}
                <input type="number" name="price" step="0.01" 
                       value="{{ '%.2f'|format(item.price) if item.price else '' }}" 
                       placeholder="Pending" style="width: 100%;">
                {% if item.suggested_price %}
                <p style="font-size: 0.85rem; color: var(--text-muted); margin: 8px 0 0;">Seller suggested: ${{ '%.2f'|format(item.suggested_price) }}</p>
                {% endif %}
                {% endif %}
            </div>

            <label style="margin-top: 15px;">Long Description</label>
            <textarea name="long_description" rows="5" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">{{ item.long_description }}</textarea>

            <hr style="margin: 30px 0;">

            <h3>Manage Photos</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-bottom: 20px;">
                {% for photo in item.gallery_photos %}
                <div style="position: relative; text-align: center;">
                    <img src="{{ url_for('uploaded_file', filename=photo.photo_url) }}" 
                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;">
                    
                    <a href="/delete_photo/{{ photo.id }}" 
                       onclick="return confirm('Delete this photo?');"
                       style="
                           position: absolute; top: -5px; right: -5px; 
                           background: red; color: white; border-radius: 50%; 
                           width: 20px; height: 20px; font-size: 12px; line-height: 20px; 
                           text-decoration: none; font-weight: bold;
                       ">
                       X
                    </a>
                    
                    {% if item.photo_url == photo.photo_url %}
                    <div style="font-size: 0.7rem; color: #28a745; font-weight: bold; margin-top: 5px;">Main Cover</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <label style="font-weight: bold; margin-top: 20px; display: block;">Add More Photos</label>
            <div style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px; text-align: center; background: #f8fafc; margin-top: 10px;">
                <input type="file" name="new_photos" id="new-photos-input" accept="image/jpeg,image/png,image/webp" multiple 
                       style="display: none;" onchange="updateNewPhotosPreview(this)">
                <label for="new-photos-input" style="cursor: pointer; display: inline-block;">
                    <i class="fas fa-camera" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                    <span style="color: var(--primary); font-weight: 600;">Click to Add Photos</span>
                </label>
                <div id="new-photos-preview" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">New photos to be added:</p>
                    <div id="new-photos-list" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;"></div>
                </div>
            </div>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 10px;">
                <i class="fas fa-info-circle"></i> New photos will be added to the gallery when you save.
            </p>

            {% if item_is_picked_up(item) and not current_user.is_admin %}
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 16px;"><i class="fas fa-info-circle"></i> Your changes will be submitted for admin approval. The item will be temporarily removed from the shop until approved.</p>
            {% endif %}
            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary">{% if item_is_picked_up(item) and not current_user.is_admin %}Submit for Approval{% else %}Save Changes{% endif %}</button>
                {% if current_user.is_admin %}
                    <a href="/admin" class="btn btn-outline">Cancel</a>
                {% else %}
                    <a href="/dashboard" class="btn btn-outline">Cancel</a>
                {% endif %}
            </div>
        </form>

        {% if not current_user.is_admin and not item_is_picked_up(item) and item.status in ('pending_valuation', 'pending_logistics', 'rejected', 'available') %}
        <hr style="margin: 30px 0;">
        <div style="padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px;">
            <h3 style="font-size: 1rem; margin-bottom: 8px; color: #991b1b;">Remove Item</h3>
            <form method="POST" id="withdraw-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="withdraw_item" value="1"/>
                <button type="button" class="btn btn-outline" style="border-color: #dc2626; color: #dc2626;" id="remove-item-btn">Remove from Campus Swap</button>
            </form>
        </div>
        <div id="remove-confirm-modal" class="remove-confirm-modal" style="display: none;">
            <div class="remove-confirm-dialog" onclick="event.stopPropagation()">
                <p class="remove-confirm-msg">Remove this item? You will be taken off the route list. No refunds.</p>
                <div class="remove-confirm-actions">
                    <button type="button" class="btn btn-outline" id="remove-cancel-btn">Cancel</button>
                    <button type="button" class="btn btn-primary" style="background: #dc2626; border-color: #dc2626;" id="remove-confirm-btn">Remove</button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    (function() {
        var removeBtn = document.getElementById('remove-item-btn');
        var withdrawForm = document.getElementById('withdraw-form');
        var modal = document.getElementById('remove-confirm-modal');
        if (removeBtn && withdrawForm && modal) {
            var cancelBtn = document.getElementById('remove-cancel-btn');
            var confirmBtn = document.getElementById('remove-confirm-btn');
            removeBtn.addEventListener('click', function() { modal.style.display = 'flex'; });
            cancelBtn.addEventListener('click', function() { modal.style.display = 'none'; });
            confirmBtn.addEventListener('click', function() { modal.style.display = 'none'; withdrawForm.submit(); });
            modal.addEventListener('click', function(e) { if (e.target === modal) modal.style.display = 'none'; });
        }
    })();
    function updateNewPhotosPreview(input) {
        const preview = document.getElementById('new-photos-preview');
        const list = document.getElementById('new-photos-list');
        
        if (input.files && input.files.length > 0) {
            preview.style.display = 'block';
            list.innerHTML = '';
            
            Array.from(input.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const thumb = document.createElement('div');
                    thumb.style.cssText = 'width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 2px solid var(--primary);';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                    thumb.appendChild(img);
                    list.appendChild(thumb);
                };
                reader.readAsDataURL(file);
            });
        } else {
            preview.style.display = 'none';
        }
    }
</script>
{% endblock %}
{% extends "layout.html" %}

{% block body_class %}add-item-wizard{% endblock %}

{% block content %}
<script>if('scrollRestoration'in history)history.scrollRestoration='manual';window.scrollTo(0,0);</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
<style>
    .add-item-wizard .wizard-container { max-width: 660px; margin: 0 auto; padding: 40px 24px 80px; }
    .wizard-header { text-align: center; margin-bottom: 40px; }
    .wizard-header h1 { font-size: 1.75rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 8px; }
    .wizard-header .sub { color: var(--text-muted); font-size: 1rem; }
    .progress-bar-wrap { height: 8px; background: rgba(6, 78, 59, 0.12); border-radius: 999px; overflow: hidden; margin-bottom: 40px; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 999px; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .wizard-step { display: none; }
    .wizard-step.active { display: block; }
    .step-title { font-size: 1.35rem; font-weight: 700; margin-bottom: 8px; }
    .step-sub { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 28px; line-height: 1.5; }
    .condition-btn { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 24px 20px; border: 2px solid #e2e8f0; border-radius: 16px; cursor: pointer; transition: all 0.25s; font-family: inherit; text-transform: none; }
    .condition-btn:hover { border-color: #cbd5e1; background: #f8fafc; }
    .condition-btn input { position: absolute; opacity: 0; }
    .condition-btn:has(input:checked) { border-color: var(--primary); background: #f0fdf4; box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12); }
    .condition-btn strong { font-size: 1.15rem; margin-bottom: 6px; font-weight: 600; }
    .condition-btn span { font-size: 0.88rem; color: var(--text-muted); line-height: 1.4; }
    .condition-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    @media (max-width: 560px) { .condition-grid { grid-template-columns: 1fr; } }
    .photos-side-by-side { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    @media (max-width: 600px) { .photos-side-by-side { grid-template-columns: 1fr; } }
    .photos-block { min-height: 200px; }
    .upload-zone { border: 2px dashed #cbd5e1; border-radius: 20px; padding: 48px 24px; text-align: center; background: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.25s; min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: rgba(240, 253, 244, 0.6); }
    .preview-container { display: none; }
    .preview-container.visible { display: block; }
    .preview-carousel { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .preview-main { flex: 1; aspect-ratio: 4/3; min-height: 200px; max-height: 260px; border-radius: 12px; overflow: hidden; background: #f1f5f9; display: flex; align-items: center; justify-content: center; position: relative; }
    .preview-main img { width: 100%; height: 100%; object-fit: contain; }
    .preview-main-crop { position: absolute; bottom: 12px; right: 12px; width: 40px; height: 40px; background: rgba(0,0,0,0.6); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 1rem; z-index: 2; }
    .preview-main-crop:hover { background: var(--primary); }
    .carousel-nav { width: 44px; height: 44px; min-width: 44px; border-radius: 50%; background: white; border: 2px solid var(--primary); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
    .carousel-nav:hover:not(:disabled) { background: var(--primary); color: white; }
    .carousel-nav:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }
    .preview-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .preview-thumb { width: 64px; height: 64px; border-radius: 10px; overflow: visible; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; }
    .preview-thumb.active { border-color: var(--primary); }
    .preview-thumb img { width: 100%; height: 100%; object-fit: contain; background: #f1f5f9; border-radius: 8px; }
    .crop-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 16px; }
    .crop-modal-overlay.visible { display: flex; }
    .crop-modal { background: white; border-radius: 16px; padding: 20px; width: min(500px, 94vw); max-height: 90vh; display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
    .crop-modal h3 { margin: 0 0 4px; font-size: 1.2rem; }
    .crop-modal-sub { margin: 0 0 8px; font-size: 0.95rem; color: var(--text-muted); }
    .crop-modal-body { width: 100%; height: min(360px, 60vh); min-height: 260px; background: #f1f5f9; border-radius: 12px; overflow: hidden; position: relative; }
    .crop-modal-body .cropper-container { width: 100% !important; height: 100% !important; max-width: 100% !important; }
    .crop-modal-body .cropper-wrap-box, .crop-modal-body .cropper-view-box { max-width: 100%; }
    .crop-modal-body img { max-width: none; display: block; }
    .crop-modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    .preview-thumb-remove { position: absolute; top: -8px; right: -8px; z-index: 3; width: 26px; height: 26px; background: #dc2626; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .price-input-wrap { display: flex; align-items: stretch; border: 2px solid #e2e8f0; border-radius: 16px; overflow: hidden; background: white; font-size: 1.5rem; }
    .price-input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12); }
    .price-input-wrap .prefix { padding: 20px 24px; background: #f1f5f9; font-weight: 700; color: var(--text-muted); display: flex; align-items: center; }
    .price-input-wrap input { border: none; border-radius: 0; box-shadow: none; flex: 1; padding: 20px 24px; font-size: 1.5rem; font-weight: 600; min-height: 0; min-width: 0; }
    .wizard-step input[type="text"]:not(#price-input), .wizard-step textarea { width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; font-family: inherit; margin-bottom: 16px; }
    .wizard-step input[type="text"]:not(#price-input):focus, .wizard-step textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.12); }
    .review-block { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 24px; margin-bottom: 20px; }
    .review-block h5 { margin: 0 0 12px; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 0.03em; }
    .review-block p { margin: 0; font-size: 1rem; font-weight: 600; }
    .review-photos { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; }
    .review-photos img { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; border: 2px solid #e2e8f0; }
    .wizard-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 24px; border-top: 1px solid #e2e8f0; }
    .btn-back { background: transparent; color: var(--text-muted); border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; padding: 12px 0; }
    .btn-back:hover { color: var(--primary); }
    .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
    @media (max-width: 500px) { .category-grid { grid-template-columns: repeat(2, 1fr); } }
    .category-card { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 24px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 16px; cursor: pointer; transition: all 0.25s; font-family: inherit; text-align: center; }
    .category-card:hover { border-color: var(--primary); background: #f0fdf4; }
    .category-card.selected { border-color: var(--primary); background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); box-shadow: 0 0 0 3px rgba(6, 78, 59, 0.15); }
    .category-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(6, 78, 59, 0.08); border-radius: 12px; color: var(--primary); font-size: 1.5rem; }
    .category-card.selected .category-icon { background: var(--primary); color: white; }
    .category-name { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
</style>

<div class="wizard-container">
    <a href="/dashboard" style="position: absolute; top: 40px; left: 24px; color: var(--text-muted); font-size: 1.5rem; text-decoration: none;"><i class="fas fa-times"></i></a>
    <div class="wizard-header">
        <h1>Add Another Item</h1>
        <p class="sub">Same smooth flow. Your settings are saved.</p>
    </div>
    <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-fill" style="width: 14.3%;"></div>
    </div>

    <form method="POST" action="{{ url_for('add_item') }}" enctype="multipart/form-data" id="item-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="quality" id="quality-input" value="4">
        <input type="file" name="photos" id="file-input" accept="image/jpeg,image/png,image/webp" multiple style="display:none;">
        <input type="hidden" name="temp_photo_ids" id="temp-photo-ids" value="">

        <div class="wizard-step active" id="step-1" data-step="1">
            <h2 class="step-title">Which of these best describes what you're selling?</h2>
            <p class="step-sub">Don't worry, you can always edit details later.</p>
            {% include '_category_grid.html' %}
        </div>

        <div class="wizard-step" id="step-2" data-step="2">
            <h2 class="step-title">What condition is your item in?</h2>
            <p class="step-sub">Be honest. Buyers appreciate accuracy.</p>
            <div class="condition-grid">
                <label class="condition-btn">
                    <input type="radio" name="condition_radio" value="like_new" data-quality="5">
                    <strong>Like new</strong>
                    <span>Used once or twice, perfect condition.</span>
                </label>
                <label class="condition-btn">
                    <input type="radio" name="condition_radio" value="4" data-quality="4">
                    <strong>Good</strong>
                    <span>Minor signs of wear, fully functional.</span>
                </label>
                <label class="condition-btn">
                    <input type="radio" name="condition_radio" value="3" data-quality="3">
                    <strong>Fair</strong>
                    <span>Visible wear, but still usable.</span>
                </label>
            </div>
        </div>

        <div class="wizard-step" id="step-3" data-step="3">
            <h2 class="step-title">Add photos</h2>
            <p class="step-sub">Show off your item. Make sure to capture any wear or tear! We recommend taking at least two photos.</p>
            <div class="photos-side-by-side">
                <div id="upload-from-computer" class="upload-zone photos-block">
                    <i class="fas fa-camera"></i>
                    <h4>Click to upload photos</h4>
                    <p>or drag and drop • JPG, PNG, or WebP</p>
                </div>
                <div id="qr-block" class="upload-zone photos-block" style="background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 100%);border-color:rgba(6,78,59,0.3);">
                    <i class="fas fa-qrcode" style="color:var(--primary);font-size:1.5rem;margin-bottom:8px;"></i>
                    <h4 style="color:var(--primary);">Upload with your phone</h4>
                    <p style="margin-bottom:12px;">Scan with your camera</p>
                    <div id="qr-container" style="min-height:140px;display:flex;align-items:center;justify-content:center;"></div>
                </div>
            </div>
            <div class="preview-container" id="preview-container">
                <div class="preview-carousel">
                    <button type="button" class="carousel-nav" id="prev-btn"><i class="fas fa-chevron-left"></i></button>
                    <div class="preview-main" id="preview-main">
                        <img id="main-preview" src="" alt="" style="display:none;">
                        <div id="no-preview" style="color:var(--text-muted);"><i class="fas fa-image" style="font-size:2.5rem;margin-bottom:8px;"></i><p>No preview</p></div>
                        <button type="button" class="preview-main-crop" id="main-crop-btn" title="Adjust photo" style="display:none;"><i class="fas fa-crop"></i></button>
                    </div>
                    <button type="button" class="carousel-nav" id="next-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="preview-thumbnails" id="thumbnails"></div>
                <p style="font-size:0.9rem;color:var(--text-muted);margin:12px 0 0;"><i class="fas fa-images"></i> <span id="file-count-text">0 photos</span> • Star your cover by clicking a thumbnail</p>
                <button type="button" id="add-more-btn" style="margin-top:12px;padding:10px 20px;background:#f8fafc;border:2px dashed #cbd5e1;border-radius:10px;color:var(--primary);font-weight:600;cursor:pointer;font-size:0.9rem;"><i class="fas fa-plus"></i> Add more</button>
            </div>
        </div>

        <div class="wizard-step" id="step-4" data-step="4">
            <h2 class="step-title">Let's give your item a name</h2>
            <p class="step-sub">Brief and specific works best. (e.g. Insignia 55&quot; flatscreen TV)</p>
            <input type="text" name="description" id="title-input" placeholder="e.g. Insignia 55&quot; flatscreen TV" required maxlength="200">
        </div>

        <div class="wizard-step" id="step-5" data-step="5">
            <h2 class="step-title">Anything we should know?</h2>
            <p class="step-sub">Dimensions, flaws, or special details. The more specific, the better.</p>
            <textarea name="long_description" rows="4" placeholder="e.g. 47&quot;W x 24&quot;D. Small scratch on left leg. Includes assembly hardware."></textarea>
        </div>

        <div class="wizard-step" id="step-6" data-step="6">
            <h2 class="step-title">How much do you want to list this for?</h2>
            <p class="step-sub">You suggest a price. We review each item and may adjust the price based on brand, condition, and market. You'll see the final price when we approve your listing.</p>
            <div class="price-input-wrap">
                <span class="prefix">$</span>
                <input type="text" name="suggested_price" id="price-input" placeholder="0" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" autocomplete="off">
            </div>
            <p class="price-disclaimer" style="font-size:0.85rem; color:var(--text-muted); margin-top:12px; line-height:1.5;">This is just a recommendation. Every item is different. We take into account brand, quality, and market trends when setting final prices.</p>
        </div>

        <div class="wizard-step" id="step-7" data-step="7">
            <h2 class="step-title">Review & publish</h2>
            <p class="step-sub">Almost done! Double-check and submit.</p>
            <div class="review-block">
                <h5>Photos</h5>
                <div id="review-photos" class="review-photos"></div>
            </div>
            <div class="review-block">
                <h5>Item</h5>
                <p id="review-category"></p>
                <p id="review-description" style="font-weight:500;margin-top:4px;"></p>
                <p id="review-condition" style="font-size:0.95rem;margin-top:4px;"></p>
                <p id="review-price" style="font-size:0.95rem;margin-top:8px;"></p>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;padding:18px;font-size:1.1rem;"><i class="fas fa-check"></i> Submit Listing for Approval</button>
        </div>
    </form>

    <div class="wizard-nav" id="wizard-nav">
        <button type="button" class="btn-back" id="btn-back" style="visibility:hidden;"><i class="fas fa-arrow-left"></i> Back</button>
        <button type="button" class="btn btn-primary" id="btn-next">Next</button>
    </div>
</div>

<div id="crop-modal-overlay" class="crop-modal-overlay">
    <div class="crop-modal">
        <h3>Adjust your photo</h3>
        <p class="crop-modal-sub">Drag the image to reposition. When it looks good, tap Apply.</p>
        <div class="crop-modal-body">
            <img id="crop-image" src="" alt="">
        </div>
        <div class="crop-modal-actions">
            <button type="button" class="btn btn-outline" id="crop-cancel">Cancel</button>
            <button type="button" class="btn btn-primary" id="crop-apply"><i class="fas fa-check"></i> Apply</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
<script>
(function() {
    const TOTAL_STEPS = 7;
    let currentStep = 1;
    let selectedFiles = [];
    let tempPhotoFilenames = [];
    let tempPhotoUrls = {};
    let currentImageIndex = 0;
    let uploadSessionToken = null;
    const form = document.getElementById('item-form');
    const fileInput = document.getElementById('file-input');
    const uploadZone = document.getElementById('upload-from-computer');
    const previewContainer = document.getElementById('preview-container');

    function goStep(step) {
        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
        document.getElementById('step-' + step).classList.add('active');
        document.getElementById('progress-fill').style.width = (step / TOTAL_STEPS * 100) + '%';
        currentStep = step;
        document.getElementById('btn-back').style.visibility = step > 1 ? 'visible' : 'hidden';
        if (step === 3 && !uploadSessionToken) loadQr();
        if (step === TOTAL_STEPS) {
            document.getElementById('btn-next').style.display = 'none';
            populateReview();
        } else {
            document.getElementById('btn-next').style.display = 'flex';
        }
        window.scrollTo(0, 0);
    }

    function validateStep(step) {
        if (step === 1 && !document.getElementById('category-id-input').value) { alert('Please select a category that best describes what you\'re selling before continuing.'); return false; }
        if (step === 2) {
            const q = document.querySelector('input[name="condition_radio"]:checked');
            if (!q) { alert('Please select the condition of your item before continuing.'); return false; }
            document.getElementById('quality-input').value = q.dataset.quality || q.value;
        }
        if (step === 3 && selectedFiles.length + tempPhotoFilenames.length === 0) { alert('Please add photos before continuing.'); return false; }
        if (step === 4 && !form.querySelector('input[name="description"]').value.trim()) { alert('Please give your item a name before continuing.'); return false; }
        return true;
    }

    document.getElementById('btn-next').onclick = function() {
        if (!validateStep(currentStep)) return;
        if (currentStep < TOTAL_STEPS) goStep(currentStep + 1);
    };
    document.getElementById('btn-back').onclick = function() { if (currentStep > 1) goStep(currentStep - 1); };

    document.querySelectorAll('.category-card').forEach(c => {
        c.onclick = function() {
            document.querySelectorAll('.category-card').forEach(x => x.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('category-id-input').value = this.dataset.categoryId;
        };
    });

    document.querySelectorAll('input[name="condition_radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('quality-input').value = this.dataset.quality || (this.value === 'like_new' ? '5' : this.value);
        });
    });

    document.getElementById('price-input').addEventListener('input', function() {
        let v = this.value.replace(/[^0-9.]/g, '');
        const parts = v.split('.');
        if (parts.length > 2) v = parts[0] + '.' + parts.slice(1).join('');
        if (parts.length === 2 && parts[1].length > 2) v = parts[0] + '.' + parts[1].slice(0, 2);
        this.value = v;
    });

    function getTotal() { return selectedFiles.length + tempPhotoFilenames.length; }
    function getAll() {
        const f = selectedFiles.map(f => ({ type: 'file', file: f }));
        const t = tempPhotoFilenames.map(fn => ({ type: 'temp', filename: fn, url: tempPhotoUrls[fn] }));
        return f.concat(t);
    }
    function addTemp(fns, urls) {
        fns.filter(f => !tempPhotoFilenames.includes(f)).forEach(fn => {
            tempPhotoFilenames.push(fn);
            tempPhotoUrls[fn] = urls[fns.indexOf(fn)] || '';
        });
        document.getElementById('temp-photo-ids').value = tempPhotoFilenames.join(',');
        updatePreviews();
        previewContainer.classList.add('visible');
    }
    function removeTemp(fn) {
        tempPhotoFilenames = tempPhotoFilenames.filter(f => f !== fn);
        delete tempPhotoUrls[fn];
        document.getElementById('temp-photo-ids').value = tempPhotoFilenames.join(',');
        if (getTotal() === 0) previewContainer.classList.remove('visible');
        else updatePreviews();
    }
    function updatePreviews() {
        const total = getTotal();
        document.getElementById('file-count-text').textContent = total + ' photo' + (total !== 1 ? 's' : '');
        const thumbs = document.getElementById('thumbnails');
        thumbs.innerHTML = '';
        getAll().forEach((it, i) => {
            const div = document.createElement('div');
            div.className = 'preview-thumb' + (i === currentImageIndex ? ' active' : '');
            const img = document.createElement('img');
            if (it.type === 'file') { const r = new FileReader(); r.onload = e => img.src = e.target.result; r.readAsDataURL(it.file); }
            else img.src = it.url;
            div.appendChild(img);
            const rm = document.createElement('div');
            rm.className = 'preview-thumb-remove';
            rm.innerHTML = '<i class="fas fa-times"></i>';
            rm.onclick = ev => { ev.stopPropagation(); removeAt(i); };
            div.appendChild(rm);
            div.onclick = () => showImg(i);
            thumbs.appendChild(div);
        });
        const items = getAll();
        if (items.length) {
            const it = items[currentImageIndex];
            const main = document.getElementById('main-preview');
            const no = document.getElementById('no-preview');
            if (it.type === 'file') { const r = new FileReader(); r.onload = e => { main.src = e.target.result; main.style.display = 'block'; no.style.display = 'none'; }; r.readAsDataURL(it.file); }
            else { main.src = it.url; main.style.display = 'block'; no.style.display = 'none'; }
        }
        const showArrows = items.length > 1;
        document.getElementById('prev-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('next-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('prev-btn').disabled = currentImageIndex === 0;
        document.getElementById('next-btn').disabled = currentImageIndex >= items.length - 1;
        const mainCropBtn = document.getElementById('main-crop-btn');
        if (mainCropBtn) {
            const cur = items[currentImageIndex];
            mainCropBtn.style.display = (cur && cur.type === 'file') ? 'flex' : 'none';
        }
    }
    function showImg(i) {
        const items = getAll();
        if (i < 0 || i >= items.length) return;
        currentImageIndex = i;
        document.querySelectorAll('.preview-thumb').forEach((t, j) => t.classList.toggle('active', j === i));
        const it = items[i];
        const main = document.getElementById('main-preview');
        const no = document.getElementById('no-preview');
        if (it.type === 'file') { const r = new FileReader(); r.onload = e => { main.src = e.target.result; main.style.display = 'block'; no.style.display = 'none'; }; r.readAsDataURL(it.file); }
        else { main.src = it.url; main.style.display = 'block'; no.style.display = 'none'; }
        const showArrows = items.length > 1;
        document.getElementById('prev-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('next-btn').style.display = showArrows ? 'flex' : 'none';
        document.getElementById('prev-btn').disabled = i === 0;
        document.getElementById('next-btn').disabled = i >= items.length - 1;
        const mainCropBtn = document.getElementById('main-crop-btn');
        if (mainCropBtn) {
            const cur = items[i];
            mainCropBtn.style.display = (cur && cur.type === 'file') ? 'flex' : 'none';
        }
    }
    function changeImage(d) { const items = getAll(); const n = currentImageIndex + d; if (n >= 0 && n < items.length) showImg(n); }
    function removeAt(i) {
        const items = getAll();
        const it = items[i];
        if (it.type === 'file') {
            selectedFiles = selectedFiles.filter(f => f !== it.file);
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
        } else removeTemp(it.filename);
        currentImageIndex = Math.min(currentImageIndex, getTotal() - 1);
        if (currentImageIndex < 0) currentImageIndex = 0;
        if (getTotal() === 0) previewContainer.classList.remove('visible');
        else updatePreviews();
    }

    let cropperInstance = null;
    let cropEditingIndex = null;

    function openCropModal(fileOrUrl, indexForReplace) {
        const imgEl = document.getElementById('crop-image');
        const overlay = document.getElementById('crop-modal-overlay');
        cropEditingIndex = indexForReplace;
        if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
        overlay.classList.add('visible');
        imgEl.onload = function() {
            requestAnimationFrame(function() {
                initCropper();
            });
        };
        if (typeof fileOrUrl === 'string') {
            imgEl.src = fileOrUrl;
            if (imgEl.complete) imgEl.onload();
        } else {
            const r = new FileReader();
            r.onload = e => {
                imgEl.src = e.target.result;
                if (imgEl.complete) imgEl.onload();
            };
            r.readAsDataURL(fileOrUrl);
        }
    }
    function initCropper() {
        const img = document.getElementById('crop-image');
        if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
        cropperInstance = new Cropper(img, {
            aspectRatio: 4 / 3,
            viewMode: 1,
            autoCropArea: 0.9,
            dragMode: 'move',
            guides: true,
            center: true,
            highlight: false
        });
    }
    function closeCropModal() {
        document.getElementById('crop-modal-overlay').classList.remove('visible');
        if (cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
        cropEditingIndex = null;
    }
    function addCroppedFile(blob) {
        const name = (cropEditingIndex !== null && selectedFiles[cropEditingIndex] ? selectedFiles[cropEditingIndex].name : null) || 'photo.jpg';
        const ext = name.split('.').pop() || 'jpg';
        const mime = ext === 'png' ? 'image/png' : ext === 'webp' ? 'image/webp' : 'image/jpeg';
        const f = new File([blob], name.replace(/\.[^.]+$/, '_cropped.'+ext) || 'photo.jpg', { type: mime });
        selectedFiles[cropEditingIndex] = f;
        const dt = new DataTransfer();
        selectedFiles.forEach(x => dt.items.add(x));
        fileInput.files = dt.files;
        closeCropModal();
        updatePreviews();
        previewContainer.classList.add('visible');
    }

    document.getElementById('main-crop-btn').onclick = function() {
        const items = getAll();
        const i = currentImageIndex;
        if (i >= 0 && i < items.length && items[i].type === 'file') openCropModal(items[i].file, i);
    };
    document.getElementById('crop-cancel').onclick = closeCropModal;
    document.getElementById('crop-apply').onclick = function() {
        if (!cropperInstance) return;
        const btn = document.getElementById('crop-apply');
        btn.disabled = true;
        try {
            const canvas = cropperInstance.getCroppedCanvas({ maxWidth: 1600, maxHeight: 1200, imageSmoothingQuality: 'high' });
            if (!canvas) { btn.disabled = false; return; }
            canvas.toBlob(function(blob) {
                btn.disabled = false;
                if (blob) addCroppedFile(blob);
            }, 'image/jpeg', 0.9);
        } catch (e) {
            btn.disabled = false;
        }
    };

    uploadZone.onclick = () => fileInput.click();
    uploadZone.ondragover = e => { e.preventDefault(); uploadZone.classList.add('dragover'); };
    uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');
    uploadZone.ondrop = e => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        if (files.length) {
            const set = new Set(selectedFiles.map(f => f.name));
            selectedFiles = selectedFiles.concat(files.filter(f => !set.has(f.name)));
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
            updatePreviews();
            previewContainer.classList.add('visible');
        }
    };
    fileInput.onchange = function() {
        const files = Array.from(this.files);
        if (files.length) {
            const set = new Set(selectedFiles.map(f => f.name));
            selectedFiles = selectedFiles.concat(files.filter(f => !set.has(f.name)));
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            this.files = dt.files;
            updatePreviews();
            previewContainer.classList.add('visible');
        }
    };
    document.getElementById('add-more-btn').onclick = () => fileInput.click();

    document.getElementById('prev-btn').addEventListener('click', () => changeImage(-1));
    document.getElementById('next-btn').addEventListener('click', () => changeImage(1));

    async function loadQr() {
        try {
            const fd = new FormData();
            fd.append('csrf_token', form.querySelector('input[name="csrf_token"]').value);
            const r = await fetch('/api/upload_session/create', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const d = await r.json();
            if (d.token) {
                uploadSessionToken = d.token;
                document.getElementById('qr-container').innerHTML = '<img src="data:image/png;base64,'+d.qr_code_base64+'" alt="QR" style="max-width:256px;">';
                setInterval(async () => {
                    if (!uploadSessionToken) return;
                    try {
                        const s = await fetch('/api/upload_session/status?token='+encodeURIComponent(uploadSessionToken));
                        const j = await s.json();
                        if (j.images && j.images.length) addTemp(j.images.map(i => i.filename), j.images.map(i => i.url));
                    } catch(e){}
                }, 2500);
            }
        } catch(e) { document.getElementById('qr-container').innerHTML = '<p style="color:#dc2626;">Could not load.</p>'; }
    }

    function populateReview() {
        const reviewPhotos = document.getElementById('review-photos');
        reviewPhotos.innerHTML = '';
        const items = getAll();
        items.forEach((item, idx) => {
            const img = document.createElement('img');
            img.alt = 'Photo ' + (idx + 1);
            if (item.type === 'file') {
                const r = new FileReader();
                r.onload = e => { img.src = e.target.result; };
                r.readAsDataURL(item.file);
            } else img.src = item.url || '';
            reviewPhotos.appendChild(img);
        });
        if (items.length === 0) reviewPhotos.innerHTML = '<p style="color:var(--text-muted);font-size:0.9rem;">No photos</p>';

        const catCard = document.querySelector('.category-card.selected');
        document.getElementById('review-category').textContent = catCard ? catCard.dataset.categoryName : '';
        document.getElementById('review-description').textContent = form.querySelector('input[name="description"]').value || '';
        const condRadio = form.querySelector('input[name="condition_radio"]:checked');
        const condMap = { 'like_new': 'Like new', '4': 'Good', '3': 'Fair', '5': 'Like new' };
        document.getElementById('review-condition').textContent = condRadio ? 'Condition: ' + (condMap[condRadio.value] || condRadio.value) : '';
        const priceVal = form.querySelector('input[name="suggested_price"]').value;
        const priceNum = parseFloat(priceVal);
        document.getElementById('review-price').textContent = priceVal && !isNaN(priceNum) ? 'Suggested: $' + priceNum.toFixed(2) : 'No suggested price';
    }

    form.onsubmit = function() {
        if (getTotal() === 0) return false;
        if (selectedFiles.length && (!fileInput.files || !fileInput.files.length)) {
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
        }
    };
})();
</script>
{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Upload Photo - Campus Swap</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0fdf4;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1 { font-size: 1.5rem; margin: 0 0 8px; color: #166534; }
        p { color: #64748b; margin: 0 0 16px; line-height: 1.5; font-size: 0.95rem; }
        .error { color: #dc2626; background: #fef2f2; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
        .file-input-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            border-left: 4px solid #e2e8f0;
            border-right: 4px solid #e2e8f0;
            border-radius: 0;
            padding: 24px 24px;
            text-align: left;
            background: #f8fafc;
            margin: 16px 0;
            cursor: pointer;
        }
        .file-input-wrap:active { background: #f1f5f9; }
        .btn-row { display: flex; flex-direction: column; gap: 12px; margin: 16px 0; }
        .file-input-wrap { margin: 0; }
        input[type="file"] { display: none; }
        .camera-icon { font-size: 2.5rem; color: #64748b; flex-shrink: 0; }
        .gallery-icon { font-size: 2.5rem; color: #64748b; flex-shrink: 0; }
        .success-msg { color: #16a34a; font-weight: 600; margin-top: 12px; }
        .success-msg::before { content: "âœ“ "; }
        .thumb { max-width: 100%; border-radius: 8px; margin-top: 12px; max-height: 200px; object-fit: contain; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Add Photo from Phone</h1>
        <p>Take a photo or choose from your gallery. It will appear on your computer.</p>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% else %}
        <form id="upload-form">
            <input type="hidden" name="token" value="{{ token }}">
            <div class="btn-row">
                <label class="file-input-wrap" for="photo-input-camera">
                    <span class="camera-icon"><i class="fas fa-camera"></i></span>
                    <span>Take a new photo</span>
                    <input id="photo-input-camera" type="file" name="photo" accept="image/jpeg,image/png,image/webp" capture="environment">
                </label>
                <label class="file-input-wrap" for="photo-input-library">
                    <span class="gallery-icon"><i class="fas fa-images"></i></span>
                    <span>Choose from photo library</span>
                    <input id="photo-input-library" type="file" name="photo" accept="image/jpeg,image/png,image/webp">
                </label>
            </div>
            <div id="status"></div>
            <img id="preview" class="thumb" style="display: none;" alt="Preview">
        </form>
        {% endif %}
    </div>

    {% if not error %}
    <script>
        const inputCamera = document.getElementById('photo-input-camera');
        const inputLibrary = document.getElementById('photo-input-library');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');
        const token = '{{ token }}';

        function handleFileSelect(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            status.textContent = 'Uploading...';
            status.className = '';

            const fd = new FormData();
            fd.append('photo', file);
            fd.append('token', token);

            fetch('/upload_from_phone?token=' + encodeURIComponent(token), {
                method: 'POST',
                body: fd,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'Photo uploaded! Check your computer.';
                    status.className = 'success-msg';
                    preview.src = data.url;
                    preview.style.display = 'block';
                    inputCamera.value = '';
                    inputLibrary.value = '';
                } else {
                    status.textContent = data.error || 'Upload failed';
                    status.className = 'error';
                }
            })
            .catch(() => {
                status.textContent = 'Upload failed. Please try again.';
                status.className = 'error';
            });
        }

        inputCamera.addEventListener('change', function() { handleFileSelect(inputCamera); });
        inputLibrary.addEventListener('change', function() { handleFileSelect(inputLibrary); });
    </script>
    {% endif %}
</body>
</html>

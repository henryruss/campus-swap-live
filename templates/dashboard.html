{% extends "layout.html" %}

{% block content %}
{% set pending_items = my_items|selectattr('status', 'equalto', 'pending_valuation')|list %}
{% set pending_logistics = my_items|selectattr('status', 'equalto', 'pending_logistics')|list %}
{% set live_items = my_items|selectattr('status', 'equalto', 'available')|list %}
{% set sold_items = my_items|selectattr('status', 'equalto', 'sold')|list %}
{% set pending_pod = pending_logistics|selectattr('collection_method', 'equalto', 'in_person')|list %}

<div class="container" style="margin-top: 32px;">
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 28px;">
        <div>
            <h1 style="margin-bottom: 4px;">Seller Studio</h1>
            <p style="margin: 0; color: var(--text-muted); font-size: 0.95rem;">Manage your inventory and track your sales.</p>
        </div>
        <a href="/logout" class="btn btn-outline" style="padding: 10px 20px; font-size: 0.9rem;">Log Out</a>
    </div>

    {# Earnings stats bar + Pickup method #}
    <div class="dashboard-stats-bar">
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Potential Earnings</div>
            <div class="dashboard-stat-value">${{ "%.0f"|format(estimated_payout + pending_payouts) }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Live + sold, not yet paid</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Paid Out</div>
            <div class="dashboard-stat-value">${{ "%.0f"|format(paid_out) }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Sent to you</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Items</div>
            <div class="dashboard-stat-value">{{ live_items|length }} live · {{ sold_items|length }} sold</div>
            {% if pending_items or pending_logistics %}
            <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 4px;">{{ pending_items|length + pending_logistics|length }} pending</div>
            {% endif %}
        </div>
        <div class="dashboard-stat dashboard-stat-pickup">
            <div class="dashboard-stat-label">Service Fee & Pickup Method</div>
            {% if pickup_method_type == 'week' %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem;">{{ pickup_method_label }}</div>
            <div style="font-size: 0.75rem; color: #15803d; margin-top: 4px;"><i class="fas fa-truck"></i> Campus Swap Pickup</div>
            {% elif pickup_method_type == 'pod' %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem;">{{ pickup_method_label }}</div>
            {% if has_in_person_items and stripe_configured %}
            <form method="POST" action="{{ url_for('upgrade_checkout') }}" style="margin-top: 8px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem;">Upgrade to Pickup</button>
            </form>
            {% endif %}
            {% elif pickup_method_type == 'needs_pickup' %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem; color: var(--text-muted);">Pickup window pending</div>
            {% elif pickup_method_type == 'needs_pod' %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem; color: var(--text-muted);">Pod location pending</div>
            {% else %}
            <div class="dashboard-stat-value" style="font-size: 0.9rem; color: var(--text-muted);">—</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Select when approved</div>
            {% endif %}
        </div>
    </div>

    <div class="dashboard-layout {% if not (has_in_person_items and stripe_configured and pickup_method_type != 'pod') %}dashboard-layout-no-sidebar{% endif %}">
        <div>
            {# Action Required: Select pickup window #}
            {% if pickup_method_type == 'needs_pickup' %}
            <div class="dashboard-section action-required-card" style="margin-bottom: 24px;">
                <h3 style="color: #92400e; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-exclamation-circle"></i> Select Pickup Window</h3>
                <p style="color: #92400e; font-size: 0.9rem;">Choose your pickup week and pay the $15 service fee to get your items live.</p>
                <button type="button" onclick="openClaimModal()" class="btn btn-primary" style="margin-top: 16px; background-color: #d97706; border-color: #d97706; padding: 12px 24px; font-size: 1rem;">Select Pickup Window</button>
            </div>
            {% endif %}

            {# Action Required: Select pod location #}
            {% if pickup_method_type == 'needs_pod' and pending_pod %}
            <div class="dashboard-section action-required-card" style="margin-bottom: 24px;">
                <h3 style="color: #92400e; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-exclamation-circle"></i> Select Pod Location</h3>
                <p style="color: #92400e; font-size: 0.9rem;">Choose your drop-off pod to complete setup. No payment required.</p>
                <a href="#pod-selection" class="btn btn-primary" style="margin-top: 16px; background-color: #d97706; border-color: #d97706; padding: 12px 24px; font-size: 1rem; display: inline-block; text-decoration: none;">Select Pod Location</a>
            </div>
            {% endif %}

            {# Guest mode card #}
            {% if current_user.is_guest_account %}
            <div class="dashboard-section guest-mode-card" style="margin-bottom: 24px;">
                <h3 style="color: #92400e; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-lock"></i> Save Your Progress</h3>
                <p style="color: #92400e; font-size: 0.9rem;">You are in <strong>Guest Mode</strong>. Create a password so you can log back in later.</p>
                <form action="/set_password" method="POST" style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="password" name="password" placeholder="Create Password" required style="flex: 1; min-width: 180px;">
                    <button type="submit" class="btn btn-primary" style="background-color: #d97706; border-color: #d97706;">Save Account</button>
                </form>
            </div>
            {% endif %}

            {# Choose Drop-off Pod (no payment) #}
            {% if pending_pod %}
            <div id="pod-selection" class="dashboard-section claim-space-card pod" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 6px; font-size: 1.15rem;"><i class="fas fa-map-marker-alt" style="color: var(--primary);"></i> Choose Drop-off Pod</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">No payment required – just pick your drop-off location.</p>
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    {% for item in pending_pod %}
                    <form method="POST" action="{{ url_for('confirm_dropoff') }}" class="pod-selection-card" style="flex: 1; min-width: 200px;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; display: block;">{{ item.description[:40] }}{% if item.description|length > 40 %}...{% endif %}</label>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <select name="dropoff_pod" required style="flex: 1; padding: 10px 12px;">
                                <option value="">Select pod...</option>
                                {% for value, label in pod_locations %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary" style="padding: 10px 18px;">Confirm</button>
                        </div>
                    </form>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# My Inventory - Personal shop with small squares + mini checklist #}
            <div class="dashboard-section no-hover">
                <h3 class="dashboard-section-title"><i class="fas fa-store"></i> My Shop</h3>
                {% if my_items %}
                <div class="dashboard-shop-grid">
                    {% set _ns = namespace(oversized_count=0) %}
                    {% for item in my_items %}
                    {% if item.status == 'rejected' %}
                        {% set bg_class = 'item-card-bg-red' %}
                    {% elif item.status == 'sold' %}
                        {% set bg_class = 'item-card-bg-green' %}
                    {% elif item.status == 'available' %}
                        {% set bg_class = 'item-card-bg-green' %}
                    {% elif item.status == 'pending_logistics' %}
                        {% set bg_class = 'item-card-bg-yellow' %}
                    {% else %}
                        {% set bg_class = 'item-card-bg-yellow' %}
                    {% endif %}
                    <div class="dashboard-item-square {{ bg_class }}">
                        <div class="dashboard-item-square-inner dashboard-item-clickable" data-item-id="{{ item.id }}" onclick="openListingModal({{ item.id }})" style="text-decoration: none; color: inherit; cursor: pointer;">
                            <div class="dashboard-item-square-img">
                                {% if item.photo_url %}
                                <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" loading="lazy" alt="{{ item.description }}">
                                {% else %}
                                <div class="dashboard-item-square-placeholder"><i class="fas fa-image"></i></div>
                                {% endif %}
                            </div>
                            <div class="dashboard-item-square-body">
                                {% if item.status not in ('pending_valuation', 'rejected') %}
                                <div class="dashboard-item-square-header">
                                    <span class="dashboard-item-square-price">${{ "%.0f"|format(item.price) if item.price else "—" }}</span>
                                </div>
                                {% endif %}
                                <p class="dashboard-item-square-desc">{{ item.description }}</p>
                                {% if item.status not in ('pending_valuation', 'rejected') %}
                                <div class="dashboard-item-type">
                                    Item type: {% if item.is_large %}Oversized{% else %}Standard{% endif %}
                                </div>
                                {% endif %}
                                <ul class="dashboard-item-checklist">
                                    {% if item.status == 'pending_valuation' %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> Pending approval</li>
                                    {% elif item.status == 'rejected' %}
                                    <li class="check-fail"><i class="fas fa-times-circle"></i> Rejected</li>
                                    {% elif item.status == 'sold' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Sold</li>
                                    {% elif item.status == 'available' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Approved</li>
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Paid</li>
                                    {% if item.is_large and item.collection_method == 'online' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Oversized fee paid</li>
                                    {% endif %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> {{ 'In store' if item.arrived_at_store_at else 'Picked up' }}</li>
                                    {% elif item.status == 'pending_logistics' and item.collection_method == 'online' %}
                                    {% if item.is_large %}{% set _ns.oversized_count = _ns.oversized_count + 1 %}{% endif %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Approved</li>
                                    {% if item.is_large and _ns.oversized_count > 1 %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> Oversized fee: Pending</li>
                                    {% endif %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> Awaiting pickup</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> In store</li>
                                    {% elif item.status == 'pending_logistics' and item.collection_method == 'in_person' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Approved</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> Select pod</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> In store</li>
                                    <li style="margin-top: 8px;"><button type="button" class="btn btn-outline" onclick="event.preventDefault(); event.stopPropagation(); var el=document.getElementById('pod-selection'); if(el) el.scrollIntoView({behavior:'smooth'});" style="width: 100%; padding: 8px; font-size: 0.75rem;"><i class="fas fa-map-marker-alt"></i> Select Pod</button></li>
                                    {% endif %}
                                </ul>
                                {% if item.status == 'pending_logistics' and item.collection_method == 'online' and item.is_large and _ns.oversized_count > 1 %}
                                <a href="{{ url_for('pay_oversize_fee', item_id=item.id) }}" onclick="event.stopPropagation()" class="btn btn-primary" style="width: 100%; margin-top: 8px; padding: 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; text-align: center;">Pay oversize fee</a>
                                {% endif %}
                                {% if item.status in ('pending_logistics', 'rejected') %}
                                <a href="/edit_item/{{ item.id }}" onclick="event.stopPropagation()" class="btn btn-outline" style="width: 100%; margin-top: 10px; padding: 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; text-align: center;"><i class="fas fa-edit"></i> Edit listing</a>
                                {% endif %}
                            </div>
                        </div>
                        {% if item.status == 'sold' %}
                        <div class="dashboard-item-sold-overlay"><span>SOLD</span></div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {# Hidden listing content for modal (one per item) #}
                <div id="listing-modal-sources" style="display: none;">
                    {% for item in my_items %}
                    <div id="listing-content-{{ item.id }}" class="listing-modal-source">
                        <div class="listing-modal-gallery">
                            {% if item.photo_url %}
                            <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" alt="{{ item.description }}" class="listing-modal-main-img">
                            {% else %}
                            <div class="listing-modal-placeholder"><i class="fas fa-image"></i> No image</div>
                            {% endif %}
                        </div>
                        <div class="listing-modal-details">
                            <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                <span class="badge" style="background: #e2e8f0; color: var(--text-muted);">#{{ item.id }}</span>
                                {% if item.status == 'sold' %}<span class="badge bg-red">SOLD</span>
                                {% elif item.status == 'available' %}<span class="badge bg-green">Live</span>
                                {% elif item.status == 'pending_valuation' %}<span class="badge" style="background: #fef3c7; color: #92400e;">Pending</span>
                                {% elif item.status == 'pending_logistics' %}<span class="badge" style="background: #fef3c7; color: #92400e;">Pending</span>
                                {% elif item.status == 'rejected' %}<span class="badge bg-red">Rejected</span>
                                {% endif %}
                            </div>
                            <h3 style="font-size: 1.25rem; margin-bottom: 8px;">{{ item.description }}</h3>
                            {% if item.status != 'pending_valuation' %}
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">
                                Item type: {% if item.is_large %}Oversized{% else %}Standard{% endif %}
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 12px;">${{ "%.2f"|format(item.price) if item.price else "—" }}</div>
                            {% endif %}
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 12px;">
                                {% for i in range(1, 6) %}<i class="fas fa-star" style="color: {% if i <= item.quality %}#f59e0b{% else %}#e2e8f0{% endif %}; font-size: 0.9rem;"></i>{% endfor %}
                                <span style="font-size: 0.85rem; color: var(--text-muted); margin-left: 6px;">{{ item.quality }}/5</span>
                            </div>
                            <p style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 20px;">{{ item.long_description or "No detailed description." }}</p>
                            {% if item.status in ('pending_valuation', 'pending_logistics', 'rejected') %}
                            <a href="/edit_item/{{ item.id }}" class="btn btn-primary" style="width: 100%; padding: 12px; text-align: center; text-decoration: none;"><i class="fas fa-edit"></i> Edit listing</a>
                            {% else %}
                            <a href="/item/{{ item.id }}" target="_blank" class="btn btn-outline" style="width: 100%; padding: 12px; text-align: center; text-decoration: none;">View in shop</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <a href="/add_item" class="btn btn-outline dashboard-add-item-btn">
                    <i class="fas fa-plus"></i> Add More Items
                </a>
                {% else %}
                <p style="color: var(--text-muted);">Upload photos of your items.</p>
                <a href="/add_item" class="btn btn-primary" style="margin-top: 16px;">Draft Items &rarr;</a>
                {% endif %}
            </div>
        </div>

        {# Sidebar - Upgrade only (Pay & Select is in header) #}
        {% if has_in_person_items and stripe_configured and pickup_method_type != 'pod' %}
        <aside class="dashboard-sidebar">
            <div class="dashboard-sidebar-pay-card">
                <form method="POST" action="{{ url_for('upgrade_checkout') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <h3 style="font-size: 0.95rem; margin-bottom: 8px; font-weight: 700;"><i class="fas fa-truck" style="color: var(--primary);"></i> Upgrade</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">Switch to Campus Swap Pickup for $15.</p>
                    <button type="submit" class="btn btn-outline" style="width: 100%; padding: 10px; font-size: 0.85rem;">Upgrade to Pickup</button>
                </form>
            </div>
        </aside>
        {% endif %}
    </div>
</div>

{# Claim Your Space Modal - Receipt Style #}
{% if pending_pickup %}
<div id="claimModal" class="dashboard-modal-overlay" style="display: none;">
    <div class="dashboard-modal" onclick="event.stopPropagation()">
        <div class="dashboard-receipt-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h3 style="margin: 0; font-size: 1.2rem;">Claim Your Space</h3>
                <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 0.85rem;">One-time payment. Pickup week applies to your whole inventory.</p>
            </div>
            <button type="button" onclick="closeClaimModal()" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-muted); font-size: 1.2rem;" aria-label="Close">&times;</button>
        </div>
        <div class="dashboard-receipt-body">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 24px;">
                <span style="font-size: 1.1rem; font-weight: 700;">Service fee</span>
                <span style="font-size: 1.25rem; font-weight: 800; color: var(--primary);">$15.00</span>
            </div>
            <form method="POST" action="{{ url_for('confirm_pickup') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label style="font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; display: block;">Pickup week</label>
                <div class="pickup-week-grid">
                    {% for value, label in pickup_weeks %}
                    <label class="pickup-week-card">
                        <input type="radio" name="pickup_week" value="{{ value }}" required>
                        <span class="pickup-week-label">{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 16px 0;"><i class="fas fa-info-circle"></i> Your choice cannot be changed after confirmation.</p>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px;">
                    <i class="fas fa-credit-card"></i> Pay $15 & Confirm Pickup
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}

{# Listing modal - popup when clicking an item in My Shop #}
{% if my_items %}
<div id="listingModal" class="dashboard-modal-overlay" style="display: none;">
    <div class="dashboard-modal listing-modal" onclick="event.stopPropagation()">
        <div class="dashboard-receipt-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h3 style="margin: 0; font-size: 1.2rem;">Listing</h3>
            <button type="button" onclick="closeListingModal()" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-muted); font-size: 1.2rem;" aria-label="Close">&times;</button>
        </div>
        <div id="listingModalBody" class="listing-modal-body"></div>
    </div>
</div>
{% endif %}

<script>
    // Listing modal (item popup)
    function openListingModal(itemId) {
        var src = document.getElementById('listing-content-' + itemId);
        var body = document.getElementById('listingModalBody');
        var modal = document.getElementById('listingModal');
        if (src && body && modal) {
            body.innerHTML = src.innerHTML;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }
    function closeListingModal() {
        var modal = document.getElementById('listingModal');
        if (modal) { modal.style.display = 'none'; document.body.style.overflow = ''; }
    }
    var listingModalEl = document.getElementById('listingModal');
    if (listingModalEl) listingModalEl.addEventListener('click', function(e) {
        if (e.target === this) closeListingModal();
    });

    // Claim modal
    function openClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    }
    function closeClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'none'; document.body.style.overflow = ''; }
    }
    var claimModal = document.getElementById('claimModal');
    if (claimModal) claimModal.addEventListener('click', function(e) {
        if (e.target === this) closeClaimModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeClaimModal();
            closeListingModal();
        }
    });

    // Scroll to anchor
    const urlParams = new URLSearchParams(window.location.search);
    const scrollTarget = urlParams.get('scroll');
    if (scrollTarget) {
        window.addEventListener('DOMContentLoaded', function() {
            const el = document.getElementById(scrollTarget);
            if (el) requestAnimationFrame(function() { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
        }, { once: true });
    }
</script>
{% endblock %}

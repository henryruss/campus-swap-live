{% extends "layout.html" %}

{% block content %}
{% set pending_items = my_items|selectattr('status', 'equalto', 'pending_valuation')|list %}
{% set pending_logistics = my_items|selectattr('status', 'equalto', 'pending_logistics')|list %}
{% set live_items = my_items|selectattr('status', 'equalto', 'available')|list %}
{% set sold_items = my_items|selectattr('status', 'equalto', 'sold')|list %}
{% set pending_pod = pending_logistics|selectattr('collection_method', 'equalto', 'in_person')|list %}

<div class="container" style="margin-top: 32px;">
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 28px;">
        <div>
            <h1 style="margin-bottom: 4px;">Seller Studio</h1>
            <p style="margin: 0; color: var(--text-muted); font-size: 0.95rem;">Manage your inventory and track your sales.</p>
        </div>
        <a href="/logout" class="btn btn-outline" style="padding: 10px 20px; font-size: 0.9rem;">Log Out</a>
    </div>

    {# Earnings stats bar #}
    <div class="dashboard-stats-bar">
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Potential Earnings</div>
            <div class="dashboard-stat-value">${{ "%.0f"|format(estimated_payout + pending_payouts) }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Live + sold, not yet paid</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Paid Out</div>
            <div class="dashboard-stat-value">${{ "%.0f"|format(paid_out) }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Sent to you</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Items</div>
            <div class="dashboard-stat-value">{{ live_items|length }} live · {{ sold_items|length }} sold</div>
            {% if pending_items or pending_logistics %}
            <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 4px;">{{ pending_items|length + pending_logistics|length }} pending</div>
            {% endif %}
        </div>
    </div>

    <div class="dashboard-layout">
        <div>
            {# Guest mode card #}
            {% if current_user.is_guest_account %}
            <div class="dashboard-section guest-mode-card" style="margin-bottom: 24px;">
                <h3 style="color: #92400e; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-lock"></i> Save Your Progress</h3>
                <p style="color: #92400e; font-size: 0.9rem;">You are in <strong>Guest Mode</strong>. Create a password so you can log back in later.</p>
                <form action="/set_password" method="POST" style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="password" name="password" placeholder="Create Password" required style="flex: 1; min-width: 180px;">
                    <button type="submit" class="btn btn-primary" style="background-color: #d97706; border-color: #d97706;">Save Account</button>
                </form>
            </div>
            {% endif %}

            {# Claim Your Space - Pickup (payment required) #}
            {% if pending_pickup %}
            <div class="dashboard-section claim-space-card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 6px; font-size: 1.15rem;"><i class="fas fa-truck" style="color: #d97706;"></i> Claim Your Space</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 12px;">Your items were approved. Pay the service fee and pick your pickup week to secure your spot.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                    {% for item in pending_pickup %}
                    <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" alt="" style="width: 48px; height: 48px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0;">
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-primary" onclick="openClaimModal()" style="width: 100%; padding: 14px;">
                    <i class="fas fa-credit-card"></i> View Receipt & Pay
                </button>
            </div>
            {% endif %}

            {# Choose Drop-off Pod (no payment) #}
            {% if pending_pod %}
            <div id="pod-selection" class="dashboard-section claim-space-card pod" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 6px; font-size: 1.15rem;"><i class="fas fa-map-marker-alt" style="color: var(--primary);"></i> Choose Drop-off Pod</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">No payment required – just pick your drop-off location.</p>
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    {% for item in pending_pod %}
                    <form method="POST" action="{{ url_for('confirm_dropoff') }}" class="pod-selection-card" style="flex: 1; min-width: 200px;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; display: block;">{{ item.description[:40] }}{% if item.description|length > 40 %}...{% endif %}</label>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <select name="dropoff_pod" required style="flex: 1; padding: 10px 12px;">
                                <option value="">Select pod...</option>
                                {% for value, label in pod_locations %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary" style="padding: 10px 18px;">Confirm</button>
                        </div>
                    </form>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# My Inventory - Unified Pinterest-style grid #}
            <div class="dashboard-section no-hover">
                <h3 class="dashboard-section-title"><i class="fas fa-box"></i> My Inventory</h3>
                {% if my_items %}
                {% if pending_pickup %}
                <p class="dashboard-section-desc" style="margin-bottom: 16px;">{{ pending_pickup|length }} item{{ 's' if pending_pickup|length != 1 else '' }} approved – complete payment above to go live.</p>
                {% endif %}
                <div class="dashboard-unified-grid">
                    {% for item in my_items %}
                    {% if item.status == 'rejected' %}
                        {% set bg_class = 'item-card-bg-red' %}
                        {% set status_label = 'Rejected' %}
                        {% set lifecycle_text = 'Rejected' %}
                    {% elif item.status == 'sold' %}
                        {% set bg_class = 'item-card-bg-green' %}
                        {% set status_label = 'Sold' %}
                        {% set lifecycle_text = 'Sold' %}
                    {% elif item.status == 'available' %}
                        {% set bg_class = 'item-card-bg-green' %}
                        {% set status_label = 'Live' %}
                        {% if item.arrived_at_store_at %}
                            {% set lifecycle_text = 'In store' %}
                        {% elif item.picked_up_at %}
                            {% set lifecycle_text = 'Picked up' %}
                        {% else %}
                            {% set lifecycle_text = 'Live' %}
                        {% endif %}
                    {% elif item.status == 'pending_logistics' %}
                        {% set bg_class = 'item-card-bg-yellow' %}
                        {% set status_label = 'Approved' %}
                        {% if item.picked_up_at %}
                            {% if item.arrived_at_store_at %}
                                {% set lifecycle_text = 'In store' %}
                            {% else %}
                                {% set lifecycle_text = 'Picked up' %}
                            {% endif %}
                        {% else %}
                            {% set lifecycle_text = 'Awaiting pickup' %}
                        {% endif %}
                    {% else %}
                        {% set bg_class = 'item-card-bg-yellow' %}
                        {% set status_label = 'Pending' %}
                        {% set lifecycle_text = 'Pending approval' %}
                    {% endif %}
                    <div class="dashboard-item-card-unified {{ bg_class }}">
                        {% if item.status == 'pending_valuation' %}
                        <a href="/edit_item/{{ item.id }}" style="text-decoration: none; color: inherit; display: block;">
                        {% elif item.status in ('available', 'sold') %}
                        <a href="/item/{{ item.id }}" target="_blank" style="text-decoration: none; color: inherit; display: block;">
                        {% endif %}
                            <div style="height: 200px; overflow: hidden;">
                                {% if item.photo_url %}
                                <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" loading="lazy" alt="{{ item.description }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                <div style="width: 100%; height: 100%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: var(--text-muted);"><i class="fas fa-image fa-2x"></i></div>
                                {% endif %}
                            </div>
                            <div style="padding: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                    <span style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">${{ "%.0f"|format(item.price) if item.price else "—" }}</span>
                                    <span class="dashboard-status-badge dashboard-status-{{ item.status }}">{{ status_label }}</span>
                                </div>
                                <p style="margin: 0 0 8px; font-size: 0.9rem; color: var(--text-muted); font-weight: 500; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;">{{ item.description }}</p>
                                <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;">{{ lifecycle_text }}</div>
                                {% if item.status == 'pending_logistics' and item.collection_method == 'online' %}
                                <button type="button" class="btn btn-primary" onclick="event.preventDefault(); event.stopPropagation(); openClaimModal();" style="width: 100%; margin-top: 12px; padding: 10px; font-size: 0.85rem;">
                                    <i class="fas fa-credit-card"></i> Pay & Select Pickup Week
                                </button>
                                {% elif item.status == 'pending_logistics' and item.collection_method == 'in_person' %}
                                <a href="#pod-selection" class="btn btn-outline" style="display: block; text-align: center; margin-top: 12px; padding: 10px; font-size: 0.85rem; text-decoration: none;">
                                    <i class="fas fa-map-marker-alt"></i> Select Pod
                                </a>
                                {% endif %}
                            </div>
                        {% if item.status in ('pending_valuation', 'available', 'sold') %}
                        </a>
                        {% endif %}
                        {% if item.status == 'sold' %}
                        <div class="dashboard-item-sold-overlay"><span>SOLD</span></div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <a href="/add_item" class="btn btn-outline" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-plus"></i> Add More Items
                </a>
                {% else %}
                <p style="color: var(--text-muted);">Upload photos of your items.</p>
                <a href="/add_item" class="btn btn-primary" style="margin-top: 16px;">Draft Items &rarr;</a>
                {% endif %}
            </div>
        </div>

        {# Sidebar - Account Settings & Quick Info #}
        <aside class="dashboard-sidebar">
            <div class="card no-hover">
                <h3 style="font-size: 1rem; margin-bottom: 16px;">Quick Access</h3>
                <a href="{{ url_for('account_settings') }}" class="dashboard-quick-link">
                    <i class="fas fa-cog" style="color: var(--primary);"></i>
                    Account Settings
                </a>
                {% if has_in_person_items and stripe_configured %}
                <form method="POST" action="{{ url_for('upgrade_checkout') }}" style="margin-bottom: 10px;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="dashboard-quick-link" style="width: 100%; border: none; background: none; cursor: pointer; font-family: inherit; text-align: left;">
                        <i class="fas fa-truck" style="color: var(--primary);"></i>
                        Upgrade to Campus Swap Pickup
                    </button>
                </form>
                {% endif %}
                {% if has_pickup_location %}
                <div class="dashboard-sidebar-status ready"><i class="fas fa-check-circle"></i> Pickup location set</div>
                {% else %}
                <div class="dashboard-sidebar-status warn"><i class="fas fa-exclamation-circle"></i> Set pickup in settings</div>
                {% endif %}
                {% if has_payout_info %}
                <div class="dashboard-sidebar-status ready"><i class="fas fa-check-circle"></i> Payout info set</div>
                {% else %}
                <div class="dashboard-sidebar-status warn"><i class="fas fa-exclamation-circle"></i> Add payout for sales</div>
                {% endif %}
            </div>
        </aside>
    </div>
</div>

{# Claim Your Space Modal - Receipt Style #}
{% if pending_pickup %}
<div id="claimModal" class="dashboard-modal-overlay" style="display: none;">
    <div class="dashboard-modal" onclick="event.stopPropagation()">
        <div class="dashboard-receipt-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h3 style="margin: 0; font-size: 1.2rem;">Claim Your Space</h3>
                <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 0.9rem;">Pickup confirmation & payment</p>
            </div>
            <button type="button" onclick="closeClaimModal()" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-muted); font-size: 1.2rem;" aria-label="Close">&times;</button>
        </div>
        <div class="dashboard-receipt-body">
            <div style="margin-bottom: 20px;">
                <div style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase;">Items to be picked up</div>
                {% set _ns = namespace(oversized_seen=0) %}
                {% for item in pending_pickup %}
                <div class="dashboard-receipt-row">
                    <span>{{ item.description[:35] }}{% if item.description|length > 35 %}...{% endif %}</span>
                    {% if item.is_large %}
                    {% if _ns.oversized_seen == 0 %}<span style="color: var(--text-muted); font-weight: 600;">Included</span>{% set _ns.oversized_seen = 1 %}
                    {% else %}<span style="color: var(--accent); font-weight: 600;">+$10</span>{% endif %}
                    {% else %}<span>—</span>{% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="dashboard-receipt-divider"></div>
            <div class="dashboard-receipt-row">
                <span>Service fee (includes 1 oversized)</span>
                <span>${{ "%.2f"|format(service_fee_cents / 100) }}</span>
            </div>
            {% if pending_pickup_additional_oversized_count and pending_pickup_additional_oversized_count > 0 %}
            <div class="dashboard-receipt-row">
                <span>Additional oversized ({{ pending_pickup_additional_oversized_count }} × $10)</span>
                <span>${{ "%.2f"|format(pending_pickup_additional_oversized_count * (large_item_fee_cents / 100)) }}</span>
            </div>
            {% endif %}
            <div class="dashboard-receipt-divider"></div>
            <div class="dashboard-receipt-row dashboard-receipt-total">
                <span>Total</span>
                <span>${{ "%.2f"|format(pending_pickup_fee_cents / 100) }}</span>
            </div>
            <form method="POST" action="{{ url_for('confirm_pickup') }}" style="margin-top: 24px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label style="font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; display: block;">Pickup week</label>
                <div style="margin-bottom: 20px;">
                    {% for value, label in pickup_weeks %}
                    <label class="pickup-week-option" style="cursor: pointer; display: flex;">
                        <input type="radio" name="pickup_week" value="{{ value }}" required style="margin: 0;">
                        <span>{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px;"><i class="fas fa-info-circle"></i> Your choice cannot be changed after confirmation.</p>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px;">
                    <i class="fas fa-credit-card"></i> Pay ${{ "%.2f"|format(pending_pickup_fee_cents / 100) }} & Confirm Pickup
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Claim modal
    function openClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    }
    function closeClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'none'; document.body.style.overflow = ''; }
    }
    var claimModal = document.getElementById('claimModal');
    if (claimModal) claimModal.addEventListener('click', function(e) {
        if (e.target === this) closeClaimModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeClaimModal();
    });

    // Scroll to anchor
    const urlParams = new URLSearchParams(window.location.search);
    const scrollTarget = urlParams.get('scroll');
    if (scrollTarget) {
        window.addEventListener('DOMContentLoaded', function() {
            const el = document.getElementById(scrollTarget);
            if (el) requestAnimationFrame(function() { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
        }, { once: true });
    }
</script>
{% endblock %}

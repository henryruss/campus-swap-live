{% extends "layout.html" %}

{% block content %}
{% set pending_items = my_items|selectattr('status', 'equalto', 'pending_valuation')|list %}
{% set pending_logistics = my_items|selectattr('status', 'equalto', 'pending_logistics')|list %}
{% set sold_items = my_items|selectattr('status', 'equalto', 'sold')|list %}
{% set pending_pod = pending_logistics|selectattr('collection_method', 'equalto', 'in_person')|list %}
{% set pending_free_items = pending_logistics|selectattr('collection_method', 'equalto', 'free')|list %}

<div class="container" style="margin-top: 32px;">
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 28px;">
        <div>
            <h1 style="margin-bottom: 4px;">Seller Studio</h1>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 4px;">
                <p style="margin: 0; color: var(--text-muted); font-size: 0.95rem;">Manage your inventory and track your sales.</p>
                {% if pickup_method_type in ('free_waiting', 'free_confirmed', 'free_rejected') or (pickup_method_type in ('week', 'needs_pickup') and has_approved_free_items) %}
                <span style="background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; border-radius: 20px; padding: 3px 10px; font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Free Plan</span>
                {% elif pickup_method_type in ('pod', 'needs_pod') %}
                <span style="background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; border-radius: 20px; padding: 3px 10px; font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Drop-off</span>
                {% elif pickup_method_type == 'needs_pickup' %}
                <span style="background: #fffbeb; color: #92400e; border: 1px solid #fde68a; border-radius: 20px; padding: 3px 10px; font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Awaiting Payment</span>
                {% elif pickup_method_type == 'week' %}
                <span style="background: #fffbeb; color: #92400e; border: 1px solid #fde68a; border-radius: 20px; padding: 3px 10px; font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">&#9733; Priority Pickup</span>
                {% endif %}
            </div>
        </div>
        <a href="/logout" class="btn btn-outline" style="padding: 10px 20px; font-size: 0.9rem;">Log Out</a>
    </div>

    {# Earnings stats bar + Pickup method #}
    <div class="dashboard-stats-bar">
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Potential Earnings</div>
            <div class="dashboard-stat-value">{% if estimated_payout + pending_payouts == 0 %}—{% else %}${{ "%.0f"|format(estimated_payout + pending_payouts) }}{% endif %}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">{% if estimated_payout + pending_payouts == 0 %}Updates once your items are approved{% else %}{{ earnings_subtext }}{% endif %}</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Paid Out</div>
            <div class="dashboard-stat-value">${{ "%.0f"|format(paid_out) }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Sent to you</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Items</div>
            <div class="dashboard-stat-value">{{ live_items|length }} live · {{ sold_items|length }} sold</div>
            {% if pending_items or pending_logistics %}
            <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 4px;">{{ pending_items|length + pending_logistics|length }} pending</div>
            {% endif %}
        </div>
        <div class="dashboard-stat dashboard-stat-pickup {% if pickup_method_type in ('pod', 'needs_pod') and has_approved_in_person_items and stripe_configured %}dashboard-stat-pickup-with-upgrade{% endif %}">
            <div class="dashboard-stat-label">{% if pickup_method_type == 'week' or pickup_method_type == 'needs_pickup' %}Pickup window{% elif pickup_method_type in ('pod', 'needs_pod') or has_in_person_items %}Pod location{% else %}Pickup window{% endif %}</div>
            {% if pickup_method_type == 'week' %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem;">{{ pickup_method_label }}</div>
            <div style="font-size: 0.75rem; color: #15803d; margin-top: 4px;"><i class="fas fa-truck"></i> {% if has_approved_free_items %}Free Plan{% else %}Campus Swap Pickup{% endif %}</div>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin: 8px 0 0; line-height: 1.4;">We optimize our pickup routes and will let you know more specifically when we're coming by {{ pod_change_deadline_display }}.</p>
            {% elif pickup_method_type == 'pod' %}
            {% if pod_change_allowed %}
            <form method="POST" action="{{ url_for('confirm_dropoff') }}" style="margin-top: 4px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <select name="dropoff_pod" style="font-size: 0.95rem; padding: 8px 12px; width: 100%; margin-bottom: 8px;">
                    {% for value, label in pod_locations %}
                    <option value="{{ value }}" {% if current_pod_value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem; width: 100%;">Update</button>
            </form>
            {% else %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem;">{{ pickup_method_label }}</div>
            {% endif %}
            <p style="font-size: 0.7rem; color: var(--text-muted); margin: 8px 0 0; line-height: 1.4;">We optimize our pod pickups based on projected volume.{% if pod_change_allowed %} You can change your pod location until {{ pod_change_deadline_display }}.{% endif %}</p>
            {% if has_approved_in_person_items and stripe_configured %}
            <a href="{{ url_for('upgrade_pickup') }}" class="btn btn-primary" style="width: 100%; padding: 10px 16px; font-size: 0.9rem; text-align: center; text-decoration: none; display: inline-block; margin-top: 12px;">Upgrade to Campus Swap Pickup</a>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">This action cannot be undone.</p>
            {% endif %}
            {% elif pickup_method_type == 'needs_pickup' %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem; color: var(--text-muted);">Pickup window pending</div>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin: 8px 0 0; line-height: 1.4;">Pay to secure your spot.</p>
            {% elif pickup_method_type == 'needs_pod' %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem; color: var(--text-muted);">Pod location pending</div>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin: 8px 0 0; line-height: 1.4;">We optimize our pod pickups based on projected volume.</p>
            {% if has_approved_in_person_items and stripe_configured %}
            <a href="{{ url_for('upgrade_pickup') }}" class="btn btn-primary" style="width: 100%; padding: 10px 16px; font-size: 0.9rem; text-align: center; text-decoration: none; display: inline-block; margin-top: 12px;">Upgrade to Campus Swap Pickup</a>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">This action cannot be undone.</p>
            {% endif %}
            {% elif pickup_method_type in ('free_confirmed', 'free_waiting') and has_approved_free_items %}
            <div class="dashboard-stat-value" style="font-size: 0.95rem; color: var(--text-muted);">Pickup window pending</div>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin: 8px 0 0; line-height: 1.4;">Add your address and phone, select a pickup week—no payment.</p>
            <a href="{{ url_for('confirm_pickup') }}" class="btn btn-primary" style="width: 100%; padding: 10px 16px; font-size: 0.9rem; text-align: center; text-decoration: none; display: inline-block; margin-top: 12px;">
                <i class="fas fa-calendar-check"></i> Confirm Pickup Details
            </a>
            {% elif pickup_method_type == 'free_waiting' %}
            <div class="dashboard-stat-value" style="font-size: 0.9rem; color: var(--text-muted);">—</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Select when approved</div>
            {% elif pickup_method_type == 'free_rejected' %}
            <div class="dashboard-stat-value" style="font-size: 0.9rem; color: var(--text-muted);">—</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Upgrade to select pickup</div>
            {% if has_approved_free_items and stripe_configured %}
            <form method="POST" action="{{ url_for('upgrade_checkout') }}" style="margin-top: 8px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 8px 12px; font-size: 0.85rem;">Upgrade to Pickup — $15</button>
            </form>
            {% endif %}
            {% else %}
            <div class="dashboard-stat-value" style="font-size: 0.9rem; color: var(--text-muted);">—</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Select when approved</div>
            {% endif %}
        </div>
    </div>

    <div class="dashboard-layout {% if not (has_in_person_items and stripe_configured and pickup_method_type == 'needs_pickup') %}dashboard-layout-no-sidebar{% endif %}">
        <div>
            {# Awaiting payment: spot not guaranteed + pay to secure #}
            {% if pickup_method_type == 'needs_pickup' %}
            <div class="dashboard-section action-required-card" style="margin-bottom: 24px; background: #fffbeb; border: 2px solid #fde68a;">
                <h3 style="color: #92400e; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-exclamation-circle"></i> Awaiting Payment</h3>
                <p style="color: #92400e; font-size: 0.9rem; margin-bottom: 16px;">Your spot on the pickup route isn't guaranteed until you pay. Pay the one-time $15 pickup fee and select your pickup week to secure your spot and get your items live. No extra charge per additional item.</p>
                <a href="{{ url_for('confirm_pickup') }}" class="btn btn-primary" style="background-color: #d97706; border-color: #d97706; padding: 12px 24px; font-size: 1rem; text-decoration: none; display: inline-block;">Select Pickup Window & Pay $15</a>
            </div>
            {% endif %}

            {# Free plan: spot not guaranteed reminder #}
            {% if pickup_method_type == 'week' and has_approved_free_items %}
            <div class="dashboard-section" style="margin-bottom: 24px; background: #fffbeb; border: 2px solid #fde68a;">
                <p style="color: #92400e; font-size: 0.9rem; margin-bottom: 12px;"><i class="fas fa-info-circle"></i> <strong>Free Plan:</strong> Your spot on the pickup route is not guaranteed. If we have retail space, you'll be on the route. We'll let you know by April 20th.</p>
                {% if stripe_configured %}
                <form method="POST" action="{{ url_for('upgrade_checkout') }}" style="margin: 0;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem; background: #166534; border-color: #166534;">
                        <i class="fas fa-arrow-up"></i> Upgrade to Pro:  $15
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}

            {# Guest mode card #}
            {% if current_user.is_guest_account %}
            <div class="dashboard-section guest-mode-card" style="margin-bottom: 24px;">
                <h3 style="color: #92400e; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-lock"></i> Save Your Progress</h3>
                <p style="color: #92400e; font-size: 0.9rem;">You are in <strong>Guest Mode</strong>. Create a password so you can log back in later.</p>
                <form action="/set_password" method="POST" style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="password" name="password" placeholder="Create Password" required style="flex: 1; min-width: 180px;">
                    <button type="submit" class="btn btn-primary" style="background-color: #d97706; border-color: #d97706;">Save Account</button>
                </form>
            </div>
            {% endif %}

            {# Free-tier status cards #}
            {% if pickup_method_type == 'free_waiting' %}
            <div class="dashboard-section" style="margin-bottom: 24px; background: {% if has_approved_free_items %}#f0fdf4; border: 2px solid #bbf7d0;{% else %}#fffbeb; border: 2px solid #fde68a;{% endif %}">
                <div style="display: flex; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        {% if has_approved_free_items %}
                        <h3 style="color: #166534; margin-bottom: 6px; font-size: 1.05rem;"><i class="fas fa-check-circle"></i> Free Plan — Items Approved</h3>
                        <p style="color: #166534; font-size: 0.9rem; margin-bottom: 12px;">Select your pickup window and add your address and phone—no payment. If we have warehouse space, you'll be on the pickup route. You can upgrade to Campus Swap Pickup anytime to secure your spot.</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <a href="{{ url_for('confirm_pickup') }}" class="btn btn-primary" style="padding: 10px 20px; font-size: 0.9rem; text-decoration: none; display: inline-block;">
                                <i class="fas fa-calendar-check"></i> Confirm Pickup Details
                            </a>
                            {% if stripe_configured %}
                            <form method="POST" action="{{ url_for('upgrade_checkout') }}" style="margin: 0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-outline" style="padding: 8px 16px; font-size: 0.85rem;">
                                    <i class="fas fa-arrow-up"></i> Upgrade to Pro — $15
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% else %}
                        <h3 style="color: #92400e; margin-bottom: 6px; font-size: 1.05rem;"><i class="fas fa-clock"></i> Free Plan — Awaiting Confirmation</h3>
                        <p style="color: #92400e; font-size: 0.9rem; margin-bottom: 12px;">Your items are pending approval. We'll let you know by April 20th if we have warehouse space.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% elif pickup_method_type == 'free_confirmed' %}
            <div class="dashboard-section" style="margin-bottom: 24px; background: #f0fdf4; border: 2px solid #bbf7d0;">
                <h3 style="color: #166534; margin-bottom: 6px; font-size: 1.05rem;"><i class="fas fa-check-circle"></i> Free Plan — Items Approved</h3>
                <p style="color: #166534; font-size: 0.9rem; margin-bottom: 12px;">Select your pickup window and add your address and phone—no payment. If we have warehouse space, you'll be on the pickup route. You can upgrade to Campus Swap Pickup anytime to secure your spot.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <a href="{{ url_for('confirm_pickup') }}" class="btn btn-primary" style="padding: 10px 20px; font-size: 0.9rem; text-decoration: none; display: inline-block;">
                        <i class="fas fa-calendar-check"></i> Confirm Pickup Details
                    </a>
                    {% if stripe_configured %}
                    <form method="POST" action="{{ url_for('upgrade_checkout') }}" style="margin: 0;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-outline" style="padding: 8px 16px; font-size: 0.85rem;">
                            <i class="fas fa-arrow-up"></i> Upgrade to Pro — $15
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% elif pickup_method_type == 'free_rejected' %}
            <div class="dashboard-section" style="margin-bottom: 24px; background: #fef2f2; border: 2px solid #fecaca;">
                <div style="display: flex; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <h3 style="color: #991b1b; margin-bottom: 6px; font-size: 1.05rem;"><i class="fas fa-exclamation-triangle"></i> Pickup Slots Are Full</h3>
                        <p style="color: #991b1b; font-size: 0.9rem; margin-bottom: 12px;">Unfortunately, all pickup slots are full for the free plan.{% if has_approved_free_items %} Upgrade to Campus Swap Pickup to guarantee your spot.{% endif %}</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            {% if has_approved_free_items and stripe_configured %}
                            <form method="POST" action="{{ url_for('upgrade_checkout') }}" style="margin: 0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem; background: #166534; border-color: #166534;">
                                    <i class="fas fa-arrow-up"></i> Upgrade to Campus Swap Pickup — $15
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Choose Drop-off Pod (no payment) – one choice for all items #}
            {% if pending_pod %}
            <div id="pod-selection" class="dashboard-section claim-space-card pod" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 6px; font-size: 1.15rem;"><i class="fas fa-map-marker-alt" style="color: var(--primary);"></i> Choose Drop-off Pod</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">No payment required – pick where you'll drop off all your items. We optimize our pod pickups based on projected volume. You can change your pod until {{ pod_change_deadline_display }}.</p>
                <form method="POST" action="{{ url_for('confirm_dropoff') }}" style="max-width: 320px;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <select name="dropoff_pod" required style="flex: 1; padding: 10px 12px;">
                            <option value="">Select pod...</option>
                            {% for value, label in pod_locations %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary" style="padding: 10px 18px;">Confirm</button>
                    </div>
                </form>
            </div>
            {% endif %}

            {# My Inventory - Personal shop with small squares + mini checklist #}
            <div class="dashboard-section no-hover">
                <h3 class="dashboard-section-title"><i class="fas fa-store"></i> My Shop</h3>
                {% if my_items %}
                <div class="dashboard-shop-grid">
                    {% set _ns = namespace(oversized_count=0) %}
                    {% set _has_included_oversized = my_items|selectattr('status','equalto','available')|selectattr('is_large')|selectattr('oversize_included_in_service_fee')|list|length > 0 %}
                    {% for item in my_items %}
                    {% if item.status == 'rejected' %}
                        {% set bg_class = 'item-card-bg-red' %}
                    {% elif item.status == 'sold' %}
                        {% set bg_class = 'item-card-bg-green' %}
                    {% elif item.status == 'available' %}
                        {# Green only when all bullets complete: in store (arrived) #}
                        {% set _all_complete = item.arrived_at_store_at is not none %}
                        {% set bg_class = 'item-card-bg-green' if _all_complete else 'item-card-bg-yellow' %}
                    {% elif item.status == 'pending_logistics' %}
                        {% set bg_class = 'item-card-bg-yellow' %}
                    {% else %}
                        {% set bg_class = 'item-card-bg-yellow' %}
                    {% endif %}
                    <div class="dashboard-item-square {{ bg_class }}">
                        <div class="dashboard-item-square-inner dashboard-item-clickable" data-item-id="{{ item.id }}" onclick="openListingModal({{ item.id }})" style="text-decoration: none; color: inherit; cursor: pointer;">
                            <div class="dashboard-item-square-img">
                                {% if item.photo_url %}
                                <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" loading="lazy" alt="{{ item.description }}">
                                {% else %}
                                <div class="dashboard-item-square-placeholder"><i class="fas fa-image"></i></div>
                                {% endif %}
                            </div>
                            <div class="dashboard-item-square-body">
                                {% if item.status not in ('pending_valuation', 'rejected') %}
                                <div class="dashboard-item-square-header">
                                    <span class="dashboard-item-square-price">${{ "%.0f"|format(item.price) if item.price else "—" }}</span>
                                    {% set _diff = ((item.price or 0) - (item.suggested_price or 0))|abs if (item.price is not none and item.suggested_price is not none) else 0 %}
                                    {% set _price_updated = item.price_updated_at is not none or (item.suggested_price is not none and item.price is not none and _diff > 0.01) %}
                                    {% set _show_badge = _price_updated and not (item.price_changed_acknowledged | default(false)) %}
                                    {% if _show_badge %}
                                    <span class="price-change-badge" data-item-id="{{ item.id }}" onclick="event.stopPropagation(); acknowledgePriceChange({{ item.id }}, this);" title="We updated the price">Pricing update</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                <p class="dashboard-item-square-desc">{{ item.description }}</p>
                                {% if item.status not in ('pending_valuation', 'rejected') %}
                                <div class="dashboard-item-type">
                                    Item type: {% if item.is_large %}Oversized{% else %}Standard{% endif %}
                                </div>
                                {% endif %}
                                <ul class="dashboard-item-checklist">
                                    {% if item.status == 'pending_valuation' %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> Pending approval</li>
                                    {% elif item.status == 'rejected' %}
                                    <li class="check-fail"><i class="fas fa-times-circle"></i> Rejected</li>
                                    {% elif item.status == 'sold' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Sold</li>
                                    {% elif item.status == 'available' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Approved</li>
                                    <li class="check-done"><i class="fas fa-check-circle"></i> {% if item.collection_method == 'in_person' %}Pod selected{% elif item.collection_method == 'free' %}Pickup confirmed{% else %}Pickup fee paid{% endif %}</li>
                                    {% if item.is_large and item.collection_method == 'online' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> {{ 'Oversize fee: paid' if item.oversize_fee_paid else 'Oversize fee: waived' }}</li>
                                    {% endif %}
                                    {% if item.picked_up_at or item.arrived_at_store_at %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> {% if item.collection_method == 'in_person' %}Dropped off{% else %}Picked up{% endif %}</li>
                                    {% else %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> {% if item.collection_method == 'in_person' %}Awaiting dropoff{% else %}Awaiting pickup{% endif %}</li>
                                    {% endif %}
                                    {% if item.arrived_at_store_at %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> In store</li>
                                    {% else %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> In store</li>
                                    {% endif %}
                                    {% elif item.status == 'pending_logistics' and item.collection_method == 'online' %}
                                    {% if item.is_large %}{% set _ns.oversized_count = _ns.oversized_count + 1 %}{% endif %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Approved</li>
                                    {% if item.is_large %}
                                    {% if _ns.oversized_count == 1 %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Oversize fee: waived</li>
                                    {% elif _has_included_oversized or _ns.oversized_count > 1 %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> Oversize fee: pending</li>
                                    {% endif %}
                                    {% endif %}
                                    <li class="check-pending"><i class="fas fa-circle"></i> Awaiting pickup</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> In store</li>
                                    {% elif item.status == 'pending_logistics' and item.collection_method == 'in_person' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Approved</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> Select pod</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> In store</li>
                                    <li style="margin-top: 8px;"><button type="button" class="btn btn-outline" onclick="event.preventDefault(); event.stopPropagation(); var el=document.getElementById('pod-selection'); if(el) el.scrollIntoView({behavior:'smooth'});" style="width: 100%; padding: 8px; font-size: 0.75rem;"><i class="fas fa-map-marker-alt"></i> Select Pod</button></li>
                                    {% elif item.status == 'pending_logistics' and item.collection_method == 'free' %}
                                    <li class="check-done"><i class="fas fa-check-circle"></i> Approved</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> Awaiting capacity confirmation</li>
                                    <li class="check-pending"><i class="fas fa-circle"></i> In store</li>
                                    {% endif %}
                                </ul>
                                {% if item.status == 'pending_logistics' and item.collection_method == 'online' and item.is_large and (_has_included_oversized or _ns.oversized_count > 1) %}
                                <a href="{{ url_for('pay_oversize_fee', item_id=item.id) }}" onclick="event.stopPropagation()" class="btn btn-primary" style="width: 100%; margin-top: 8px; padding: 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; text-align: center;">Pay oversize fee</a>
                                {% endif %}
                                {% if item.status == 'pending_valuation' or item.status == 'pending_logistics' or (item.status == 'available' and item.collection_method == 'in_person' and not item.arrived_at_store_at) %}
                                <a href="/edit_item/{{ item.id }}" onclick="event.stopPropagation()" class="btn btn-outline" style="width: 100%; margin-top: 10px; padding: 8px; font-size: 0.75rem; text-decoration: none; display: inline-block; text-align: center;"><i class="fas fa-edit"></i> Edit listing</a>
                                {% endif %}
                            </div>
                        </div>
                        {% if item.status == 'sold' %}
                        <div class="dashboard-item-sold-overlay"><span>SOLD</span></div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {# Hidden listing content for modal (one per item) #}
                <div id="listing-modal-sources" style="display: none;">
                    {% for item in my_items %}
                    <div id="listing-content-{{ item.id }}" class="listing-modal-source">
                        <div class="listing-modal-gallery">
                            {% if item.photo_url %}
                            <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" alt="{{ item.description }}" class="listing-modal-main-img">
                            {% else %}
                            <div class="listing-modal-placeholder"><i class="fas fa-image"></i> No image</div>
                            {% endif %}
                            {% if item.status == 'pending_valuation' or item.status == 'pending_logistics' or (item.status == 'available' and item.collection_method == 'in_person' and not item.arrived_at_store_at) %}
                            <a href="/edit_item/{{ item.id }}" class="btn btn-primary" style="width: 100%; margin-top: 12px; padding: 10px; font-size: 0.9rem; text-align: center; text-decoration: none; display: block;"><i class="fas fa-edit"></i> Edit listing</a>
                            {% endif %}
                        </div>
                        <div class="listing-modal-details">
                            <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                <span class="badge" style="background: #e2e8f0; color: var(--text-muted);">Item ID #{{ item.id }}</span>
                                {% if item.status == 'sold' %}<span class="badge bg-red">SOLD</span>
                                {% elif item.status == 'available' %}{% if item.id in live_item_ids %}<span class="badge bg-green">Live</span>{% else %}<span class="badge" style="background: #fef3c7; color: #92400e;">Pending</span>{% endif %}
                                {% elif item.status == 'pending_valuation' %}<span class="badge" style="background: #fef3c7; color: #92400e;">Pending</span>
                                {% elif item.status == 'pending_logistics' %}<span class="badge" style="background: #fef3c7; color: #92400e;">Pending</span>
                                {% elif item.status == 'rejected' %}<span class="badge bg-red">Rejected</span>
                                {% endif %}
                            </div>
                            <h3 style="font-size: 1.25rem; margin-bottom: 8px;">{{ item.description }}</h3>
                            {% if item.status != 'pending_valuation' %}
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">
                                Item type: {% if item.is_large %}Oversized{% else %}Standard{% endif %}
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 12px;">${{ "%.2f"|format(item.price) if item.price else "—" }}</div>
                            {% endif %}
                            <div style="margin-bottom: 12px;">
                                <span style="font-size: 0.85rem; color: var(--text-muted);">{{ item.quality|quality_label }}</span>
                            </div>
                            <p style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 20px;">{{ item.long_description or "No detailed description." }}</p>
                            {% if item.status == 'pending_valuation' %}
                            <a href="/edit_item/{{ item.id }}" class="btn btn-primary" style="width: 100%; padding: 12px; text-align: center; text-decoration: none; margin-bottom: 8px;"><i class="fas fa-edit"></i> Edit listing</a>
                            <form method="POST" action="{{ url_for('edit_item', item_id=item.id) }}" style="margin: 0;" onsubmit="return confirm('Remove this item permanently? This cannot be undone.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="withdraw_item" value="1"/>
                                <button type="submit" class="btn btn-outline" style="width: 100%; padding: 12px; text-align: center; border-color: #dc2626; color: #dc2626; background: none; border-width: 2px; cursor: pointer; font-size: 1rem;">Remove item</button>
                            </form>
                            {% elif item.status == 'pending_logistics' or (item.status == 'available' and item.collection_method == 'in_person' and not item.arrived_at_store_at) %}
                            <a href="/edit_item/{{ item.id }}" class="btn btn-primary" style="width: 100%; padding: 12px; text-align: center; text-decoration: none;"><i class="fas fa-edit"></i> Edit listing</a>
                            {% elif item.status == 'rejected' %}
                            <form method="POST" action="{{ url_for('edit_item', item_id=item.id) }}" style="margin: 0;" onsubmit="return confirm('Remove this item permanently? This cannot be undone.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="withdraw_item" value="1"/>
                                <button type="submit" class="btn btn-outline" style="width: 100%; padding: 12px; text-align: center; border-color: #dc2626; color: #dc2626; background: none; border-width: 2px; cursor: pointer; font-size: 1rem;">Remove item</button>
                            </form>
                            {% elif item.status == 'available' %}
                            <a href="/item/{{ item.id }}" target="_blank" class="btn btn-outline" style="width: 100%; padding: 12px; text-align: center; text-decoration: none;">View in shop</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <a href="/add_item" class="btn btn-outline dashboard-add-item-btn">
                    <i class="fas fa-plus"></i> Add More Items
                </a>
                {% else %}
                <p style="color: var(--text-muted);">Upload photos of your items.</p>
                <a href="/add_item" class="btn btn-primary" style="margin-top: 16px;">Draft Items &rarr;</a>
                {% endif %}
            </div>
        </div>

        {# Sidebar - Only for needs_pickup (header has upgrade for pod/needs_pod) #}
        {% if has_in_person_items and stripe_configured and pickup_method_type == 'needs_pickup' %}
        <aside class="dashboard-sidebar">
            <div class="dashboard-sidebar-pay-card">
                <form method="POST" action="{{ url_for('upgrade_checkout') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <h3 style="font-size: 0.95rem; margin-bottom: 8px; font-weight: 700;"><i class="fas fa-truck" style="color: var(--primary);"></i> Upgrade</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">Switch to Campus Swap Pickup for a one-time $15 pickup fee. No extra per item.</p>
                    <button type="submit" class="btn btn-outline" style="width: 100%; padding: 10px; font-size: 0.85rem;">Upgrade to Pickup</button>
                </form>
            </div>
        </aside>
        {% endif %}
    </div>
</div>

{# Claim Your Space Modal - Receipt Style #}
{% if pending_pickup %}
<div id="claimModal" class="dashboard-modal-overlay" style="display: none;">
    <div class="dashboard-modal" onclick="event.stopPropagation()">
        <div class="dashboard-receipt-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h3 style="margin: 0; font-size: 1.2rem;">Claim Your Space</h3>
                <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 0.85rem;">One-time payment. Pickup week applies to your whole inventory.</p>
            </div>
            <button type="button" onclick="closeClaimModal()" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-muted); font-size: 1.2rem;" aria-label="Close">&times;</button>
        </div>
        <div class="dashboard-receipt-body">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 8px;">
                <span style="font-size: 1.1rem; font-weight: 700;">One-time pickup fee</span>
                <span style="font-size: 1.25rem; font-weight: 800; color: var(--primary);">$15.00</span>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0 0 24px;">Covers all items — no extra per additional item.</p>
            <form method="POST" action="{{ url_for('confirm_pickup') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label style="font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; display: block;">Pickup week</label>
                <div class="pickup-week-grid">
                    {% for value, label in pickup_weeks %}
                    <label class="pickup-week-card">
                        <input type="radio" name="pickup_week" value="{{ value }}" required>
                        <span class="pickup-week-label">{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 16px 0;"><i class="fas fa-info-circle"></i> Your choice cannot be changed after confirmation.</p>
                <p style="font-size: 0.8rem; color: #166534; margin: 0 0 16px; font-weight: 600;"><i class="fas fa-check-circle"></i> Your spot is secured once payment is complete.</p>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px;">
                    <i class="fas fa-credit-card"></i> Pay $15 & Confirm Pickup
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}

{# Listing modal - popup when clicking an item in My Shop #}
{% if my_items %}
<div id="listingModal" class="dashboard-modal-overlay" style="display: none;">
    <div class="dashboard-modal listing-modal" onclick="event.stopPropagation()">
        <div class="dashboard-receipt-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <h3 style="margin: 0; font-size: 1.2rem;">Listing</h3>
            <button type="button" onclick="closeListingModal()" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-muted); font-size: 1.2rem;" aria-label="Close">&times;</button>
        </div>
        <div id="listingModalBody" class="listing-modal-body"></div>
    </div>
</div>
{% endif %}

<script>
    // Listing modal (item popup)
    function openListingModal(itemId) {
        var src = document.getElementById('listing-content-' + itemId);
        var body = document.getElementById('listingModalBody');
        var modal = document.getElementById('listingModal');
        if (src && body && modal) {
            body.innerHTML = src.innerHTML;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }
    function closeListingModal() {
        var modal = document.getElementById('listingModal');
        if (modal) { modal.style.display = 'none'; document.body.style.overflow = ''; }
    }
    var listingModalEl = document.getElementById('listingModal');
    if (listingModalEl) listingModalEl.addEventListener('click', function(e) {
        if (e.target === this) closeListingModal();
    });

    // Claim modal
    function openClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    }
    function closeClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'none'; document.body.style.overflow = ''; }
    }
    var claimModal = document.getElementById('claimModal');
    if (claimModal) claimModal.addEventListener('click', function(e) {
        if (e.target === this) closeClaimModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeClaimModal();
            closeListingModal();
        }
    });

    // Price change acknowledgment
    function acknowledgePriceChange(itemId, badgeEl) {
        if (!badgeEl) return;
        var csrf = document.querySelector('input[name="csrf_token"]');
        if (!csrf) return;
        badgeEl.style.opacity = '0.5';
        badgeEl.style.pointerEvents = 'none';
        fetch('/api/item/' + itemId + '/acknowledge_price_change', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest' },
            body: 'csrf_token=' + encodeURIComponent(csrf.value)
        }).then(function(r) {
            if (r.ok) {
                badgeEl.remove();
            } else {
                badgeEl.style.opacity = '';
                badgeEl.style.pointerEvents = '';
            }
        }).catch(function() {
            badgeEl.style.opacity = '';
            badgeEl.style.pointerEvents = '';
        });
    }

    // Scroll to anchor
    const urlParams = new URLSearchParams(window.location.search);
    const scrollTarget = urlParams.get('scroll');
    if (scrollTarget) {
        window.addEventListener('DOMContentLoaded', function() {
            const el = document.getElementById(scrollTarget);
            if (el) requestAnimationFrame(function() { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
        }, { once: true });
    }
</script>
{% endblock %}

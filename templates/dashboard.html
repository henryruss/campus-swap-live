{% extends "layout.html" %}

{% block content %}
{% set pending_items = my_items|selectattr('status', 'equalto', 'pending_valuation')|list %}
{% set pending_logistics = my_items|selectattr('status', 'equalto', 'pending_logistics')|list %}
{% set live_items = my_items|selectattr('status', 'equalto', 'available')|list %}
{% set sold_items = my_items|selectattr('status', 'equalto', 'sold')|list %}
{% set pending_pod = pending_logistics|selectattr('collection_method', 'equalto', 'in_person')|list %}

<div class="container" style="margin-top: 32px;">
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 28px;">
        <div>
            <h1 style="margin-bottom: 4px;">Seller Studio</h1>
            <p style="margin: 0; color: var(--text-muted); font-size: 0.95rem;">Manage your inventory and track your sales.</p>
        </div>
        <a href="/logout" class="btn btn-outline" style="padding: 10px 20px; font-size: 0.9rem;">Log Out</a>
    </div>

    {# Earnings stats bar #}
    <div class="dashboard-stats-bar">
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Potential Earnings</div>
            <div class="dashboard-stat-value">${{ "%.0f"|format(estimated_payout + pending_payouts) }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Live + sold, not yet paid</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Paid Out</div>
            <div class="dashboard-stat-value">${{ "%.0f"|format(paid_out) }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Sent to you</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-label">Items</div>
            <div class="dashboard-stat-value">{{ live_items|length }} live · {{ sold_items|length }} sold</div>
            {% if pending_items or pending_logistics %}
            <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 4px;">{{ pending_items|length + pending_logistics|length }} pending</div>
            {% endif %}
        </div>
    </div>

    <div class="dashboard-layout">
        <div>
            {# Guest mode card #}
            {% if current_user.is_guest_account %}
            <div class="dashboard-section guest-mode-card" style="margin-bottom: 24px;">
                <h3 style="color: #92400e; margin-bottom: 8px; font-size: 1.1rem;"><i class="fas fa-lock"></i> Save Your Progress</h3>
                <p style="color: #92400e; font-size: 0.9rem;">You are in <strong>Guest Mode</strong>. Create a password so you can log back in later.</p>
                <form action="/set_password" method="POST" style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="password" name="password" placeholder="Create Password" required style="flex: 1; min-width: 180px;">
                    <button type="submit" class="btn btn-primary" style="background-color: #d97706; border-color: #d97706;">Save Account</button>
                </form>
            </div>
            {% endif %}

            {# Claim Your Space - Pickup (payment required) #}
            {% if pending_pickup %}
            <div class="dashboard-section claim-space-card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 6px; font-size: 1.15rem;"><i class="fas fa-truck" style="color: #d97706;"></i> Claim Your Space</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">Your items were approved. Pay the service fee and pick your pickup week to secure your spot.</p>
                <button type="button" class="btn btn-primary" onclick="openClaimModal()" style="width: 100%; padding: 14px;">
                    <i class="fas fa-credit-card"></i> View Receipt & Pay
                </button>
            </div>
            {% endif %}

            {# Choose Drop-off Pod (no payment) #}
            {% if pending_pod %}
            <div class="dashboard-section claim-space-card pod" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 6px; font-size: 1.15rem;"><i class="fas fa-map-marker-alt" style="color: var(--primary);"></i> Choose Drop-off Pod</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">No payment required – just pick your drop-off location.</p>
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    {% for item in pending_pod %}
                    <form method="POST" action="{{ url_for('confirm_dropoff') }}" class="pod-selection-card" style="flex: 1; min-width: 200px;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; display: block;">{{ item.description[:40] }}{% if item.description|length > 40 %}...{% endif %}</label>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <select name="dropoff_pod" required style="flex: 1; padding: 10px 12px;">
                                <option value="">Select pod...</option>
                                {% for value, label in pod_locations %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary" style="padding: 10px 18px;">Confirm</button>
                        </div>
                    </form>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# My Inventory #}
            <div class="dashboard-section no-hover">
                <h3 class="dashboard-section-title"><i class="fas fa-box"></i> My Inventory</h3>
                {% if my_items %}

                {% if pending_items %}
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 700;"><i class="fas fa-hourglass-half" style="color: #3b82f6;"></i> Pending Approval ({{ pending_items|length }})</h4>
                    <p class="dashboard-section-desc" style="margin-bottom: 12px;">These items are awaiting pricing. You can still edit them.</p>
                    <div class="dashboard-inventory-grid">
                        {% for item in pending_items %}
                        <a href="/edit_item/{{ item.id }}" class="dashboard-item-card pending" style="position: relative; text-decoration: none; color: inherit;">
                            <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" class="dashboard-item-thumb" alt="">
                            <span class="dashboard-item-badge edit"><i class="fas fa-edit"></i> Edit</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if live_items %}
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 700;"><i class="fas fa-store" style="color: var(--primary);"></i> Live in Store ({{ live_items|length }})</h4>
                    <p class="dashboard-section-desc" style="margin-bottom: 12px;">These items are live. Prices are set and cannot be edited.</p>
                    <div class="dashboard-inventory-grid">
                        {% for item in live_items %}
                        <a href="/item/{{ item.id }}" target="_blank" class="dashboard-item-card live" style="text-decoration: none; color: inherit;">
                            <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" class="dashboard-item-thumb" alt="">
                            <div class="dashboard-item-info">
                                <div class="dashboard-item-price">${{ "%.0f"|format(item.price) if item.price else "-" }}</div>
                                <div class="dashboard-item-desc">{{ item.description }}</div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if sold_items %}
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 700;"><i class="fas fa-check-circle" style="color: #15803d;"></i> Sold ({{ sold_items|length }})</h4>
                    <div class="dashboard-inventory-grid">
                        {% for item in sold_items %}
                        <div class="dashboard-item-card sold" style="position: relative;">
                            <img src="{{ url_for('uploaded_file', filename=item.photo_url) }}" class="dashboard-item-thumb" alt="">
                            <span class="dashboard-item-badge sold">SOLD</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <a href="/add_item" class="btn btn-outline" style="width: 100%; margin-top: 8px;">
                    <i class="fas fa-plus"></i> Add More Items
                </a>
                {% else %}
                <p style="color: var(--text-muted);">Upload photos of your items.</p>
                <a href="/add_item" class="btn btn-primary" style="margin-top: 16px;">Draft Items &rarr;</a>
                {% endif %}
            </div>
        </div>

        {# Sidebar - Account Settings & Quick Info #}
        <aside class="dashboard-sidebar">
            <div class="card no-hover">
                <h3 style="font-size: 1rem; margin-bottom: 16px;">Quick Access</h3>
                <a href="{{ url_for('account_settings') }}" class="dashboard-quick-link">
                    <i class="fas fa-cog" style="color: var(--primary);"></i>
                    Account Settings
                </a>
                {% if has_pickup_location %}
                <div class="dashboard-sidebar-status ready"><i class="fas fa-check-circle"></i> Pickup location set</div>
                {% else %}
                <div class="dashboard-sidebar-status warn"><i class="fas fa-exclamation-circle"></i> Set pickup in settings</div>
                {% endif %}
                {% if has_payout_info %}
                <div class="dashboard-sidebar-status ready"><i class="fas fa-check-circle"></i> Payout info set</div>
                {% else %}
                <div class="dashboard-sidebar-status warn"><i class="fas fa-exclamation-circle"></i> Add payout for sales</div>
                {% endif %}
            </div>
        </aside>
    </div>
</div>

{# Claim Your Space Modal - Receipt Style #}
{% if pending_pickup %}
<div id="claimModal" class="dashboard-modal-overlay" style="display: none;">
    <div class="dashboard-modal" onclick="event.stopPropagation()">
        <div class="dashboard-receipt-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h3 style="margin: 0; font-size: 1.2rem;">Claim Your Space</h3>
                <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 0.9rem;">Pickup confirmation & payment</p>
            </div>
            <button type="button" onclick="closeClaimModal()" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-muted); font-size: 1.2rem;" aria-label="Close">&times;</button>
        </div>
        <div class="dashboard-receipt-body">
            <div style="margin-bottom: 20px;">
                <div style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase;">Items to be picked up</div>
                {% for item in pending_pickup %}
                <div class="dashboard-receipt-row">
                    <span>{{ item.description[:35] }}{% if item.description|length > 35 %}...{% endif %}</span>
                    {% if item.is_large %}<span style="color: var(--accent); font-weight: 600;">+$10</span>{% else %}<span>—</span>{% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="dashboard-receipt-divider"></div>
            <div class="dashboard-receipt-row">
                <span>Service fee (guaranteed space)</span>
                <span>${{ "%.2f"|format(service_fee_cents / 100) }}</span>
            </div>
            {% if pending_pickup_large_count %}
            <div class="dashboard-receipt-row">
                <span>Oversized items ({{ pending_pickup_large_count }} × $10)</span>
                <span>${{ "%.2f"|format(pending_pickup_large_count * (large_item_fee_cents / 100)) }}</span>
            </div>
            {% endif %}
            <div class="dashboard-receipt-divider"></div>
            <div class="dashboard-receipt-row dashboard-receipt-total">
                <span>Total</span>
                <span>${{ "%.2f"|format(pending_pickup_fee_cents / 100) }}</span>
            </div>
            <form method="POST" action="{{ url_for('confirm_pickup') }}" style="margin-top: 24px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <label style="font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; display: block;">Pickup week</label>
                <div style="margin-bottom: 20px;">
                    {% for value, label in pickup_weeks %}
                    <label class="pickup-week-option" style="cursor: pointer; display: flex;">
                        <input type="radio" name="pickup_week" value="{{ value }}" required style="margin: 0;">
                        <span>{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px;"><i class="fas fa-info-circle"></i> Your choice cannot be changed after confirmation.</p>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px;">
                    <i class="fas fa-credit-card"></i> Pay ${{ "%.2f"|format(pending_pickup_fee_cents / 100) }} & Confirm Pickup
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Claim modal
    function openClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    }
    function closeClaimModal() {
        var m = document.getElementById('claimModal');
        if (m) { m.style.display = 'none'; document.body.style.overflow = ''; }
    }
    var claimModal = document.getElementById('claimModal');
    if (claimModal) claimModal.addEventListener('click', function(e) {
        if (e.target === this) closeClaimModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeClaimModal();
    });

    // Scroll to anchor
    const urlParams = new URLSearchParams(window.location.search);
    const scrollTarget = urlParams.get('scroll');
    if (scrollTarget) {
        window.addEventListener('DOMContentLoaded', function() {
            const el = document.getElementById(scrollTarget);
            if (el) requestAnimationFrame(function() { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
        }, { once: true });
    }
</script>
{% endblock %}
